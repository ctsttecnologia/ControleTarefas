
{% extends "controle_de_telefone/_base_telefone.html" %}

{% block title %}Detalhes do Vínculo{% endblock %}

{% block content %}
<div class="container mt-4 mb-4">

    {# CABEÇALHO DA PÁGINA COM TÍTULO E BOTÕES DE AÇÃO PRINCIPAIS #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Detalhes do Vínculo</h2>
            <p class="text-muted mb-0">Visão completa das informações do vínculo.</p>
        </div>
        <div>
            <a href="{% url 'controle_de_telefone:vinculo_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
            {% if perms.controle_de_telefone.change_vinculo %}
            <a href="{% url 'controle_de_telefone:vinculo_update' vinculo.pk %}" class="btn btn-primary">
                <i class="fas fa-edit me-1"></i> Editar Vínculo
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row gy-4">
        {# COLUNA DA ESQUERDA: INFORMAÇÕES DO VÍNCULO E HISTÓRICO #}
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-link me-2"></i>
                        Vínculo de {{ vinculo.funcionario.nome_completo }}
                    </h5>
                    {% if vinculo.status == 'ativo' %}
                        <span class="badge bg-success fs-6"><i class="fas fa-check-circle me-1"></i> Ativo</span>
                    {% else %}
                        <span class="badge bg-secondary fs-6"><i class="fas fa-times-circle me-1"></i> Finalizado</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4 col-md-3">Data de Entrega:</dt>
                        <dd class="col-sm-8 col-md-9">{{ vinculo.data_entrega|date:"d/m/Y" }}</dd>
                        
                        <hr class="my-2">

                        <dt class="col-sm-4 col-md-3">Data de Devolução:</dt>
                        <dd class="col-sm-8 col-md-9">
                            {% if vinculo.data_devolucao %}
                                {{ vinculo.data_devolucao|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted">Ainda não devolvido.</span>
                            {% endif %}
                        </dd>
                    </dl>

                    {# Mostra o botão de devolução apenas se o vínculo estiver ativo #}
                    {% if not vinculo.data_devolucao and vinculo.status == 'ativo' %}
                    <div class="mt-3 text-end">
                        <a href="{% url 'controle_de_telefone:vinculo_update' vinculo.pk %}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-undo me-1"></i> Iniciar Devolução
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i> Histórico de Alterações
                    </h5>
                </div>
                {% if vinculo.historico.all %}
                <ul class="list-group list-group-flush">
                    {% for log in vinculo.historico.all %}
                    <li class="list-group-item">
                        <small>{{ log }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="card-body">
                    <p class="text-muted mb-0">Nenhuma alteração registrada para este vínculo.</p>
                </div>
                {% endif %}
            </div>
        </div>

        {# COLUNA DA DIREITA: INFORMAÇÕES DO COLABORADOR E RECURSOS #}
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i> Colaborador</h5>
                </div>
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <strong>Nome:</strong><br>
                        {{ vinculo.funcionario.nome_completo }}
                    </div>
                    <div class="list-group-item">
                        <strong>Matrícula:</strong><br>
                        {{ vinculo.funcionario.matricula }}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i> Recursos Vinculados</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>Aparelho:</strong>
                        {{ vinculo.aparelho|default:'<span class="text-muted">Nenhum</span>'|safe }}
                    </li>
                    <li class="list-group-item">
                        <strong>Linha:</strong>
                        {{ vinculo.linha|default:'<span class="text-muted">Nenhuma</span>'|safe }}
                    </li>
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Termo de Responsabilidade:</strong>
                            <div class="d-flex align-items-center gap-2">

                                {# --- LÓGICA DE BOTÕES DO TERMO --- #}

                                {% if vinculo.foi_assinado %}
                                    {% if vinculo.termo_assinado_upload %}
                                        <a href="{{ vinculo.termo_assinado_upload.url }}" target="_blank" class="btn btn-success btn-sm">
                                            <i class="fas fa-download me-1"></i> Baixar Assinado
                                        </a>
                                    {% else %}
                                        <span class="badge bg-danger">Falha ao gerar PDF</span>
                                    {% endif %}
                                {% else %}
                                    {% if vinculo.termo_gerados %}
                                        <a href="{{ vinculo.termo_gerados.url }}" target="_blank" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-file-pdf me-1"></i> Ver Termo
                                        </a>
                                        <a href="{% url 'controle_de_telefone:assinar_termo' object.pk %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-pen-alt me-1"></i> Assinar
                                        </a>
                                    {% else %}
                                        <span class="text-muted fst-italic">Não gerado</span>
                                        {% if perms.controle_de_telefone.change_vinculo %}
                                        <form action="{% url 'controle_de_telefone:regenerar_termo' object.pk %}" method="post" class="d-inline ms-1">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Gerar PDF do Termo">
                                                <i class="fas fa-sync-alt"></i> Gerar
                                            </button>
                                        </form>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

