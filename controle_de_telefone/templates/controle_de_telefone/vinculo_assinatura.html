
{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">{{ titulo }}</h4>
        </div>
        <div class="card-body">
            <p class="lead">
                Por favor, leia atentamente o <strong>Termo de Responsabilidade</strong>, visualize o documento gerado e, em seguida, assine no campo abaixo ou faça o upload do documento assinado.
            </p>

            <div class="row mb-4 p-3 bg-light rounded border">
                <div class="col-md-6">
                    <h5><i class="fas fa-user me-2"></i>Detalhes do Colaborador</h5>
                    <p><strong>Nome:</strong> {{ object.funcionario.nome_completo }}</p>
                    <p><strong>Matrícula:</strong> {{ object.funcionario.matricula }}</p>
                </div>
                <div class="col-md-6">
                    <h5><i class="fas fa-mobile-alt me-2"></i>Detalhes do Equipamento</h5>
                    <p><strong>Aparelho:</strong> {{ object.aparelho.modelo }}</p>
                    <p><strong>IMEI:</strong> {{ object.aparelho.imei }}</p>
                    <p><strong>Linha:</strong> {{ object.linha.numero }}</p>
                </div>
            </div>

            <h5><i class="fas fa-file-pdf me-2"></i>Termo de Responsabilidade Gerado</h5>
            <p>
                <a href="{{ object.termo_gerado.url }}" target="_blank" class="btn btn-sm btn-secondary">
                    <i class="fas fa-download me-1"></i> Baixar Termo para Impressão
                </a>
            </p>
            <iframe src="{{ object.termo_gerado.url }}" width="100%" height="500px" class="border rounded mb-4"></iframe>

            <div class="mb-4">
                <h5>Cláusulas Principais</h5>
                {% for key, clause in termo_clauses.items %}
                    <p class="small text-muted"> <i class="fas fa-check-circle text-success me-2"></i>{{ clause }}</p>
                {% endfor %}
            </div>

            <hr>
            
            <form method="post" enctype="multipart/form-data" id="signature-form">
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="mb-4">
                    <h5>Opção 1: Desenhe sua Assinatura Digital</h5>
                    <div class="signature-pad-container border rounded" style="background-color: #f8f9fa;">
                        <canvas id="signature-canvas" style="width: 100%; height: 200px; cursor: crosshair;"></canvas>
                    </div>
                    <button type="button" id="clear-signature" class="btn btn-sm btn-outline-secondary mt-2">
                        <i class="fas fa-eraser me-1"></i> Limpar Assinatura
                    </button>
                </div>

                <div class="mb-3">
                     <h5>Opção 2: Faça o Upload do Termo Assinado</h5>
                     <p><small class="text-muted">Imprima o termo, assine, digitalize e envie o arquivo (PDF, JPG, PNG).</small></p>
                    {{ form.termo_assinado }}
                </div>
                
                {{ form.assinatura_digital }}
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreement-checkbox" required>
                    <label class="form-check-label fw-bold" for="agreement-checkbox">
                       Declaro que li e concordo com todas as cláusulas descritas neste termo, e que recebi os equipamentos em perfeito estado de conservação e funcionamento.
                    </label>
                </div>

                <div class="d-flex justify-content-end">
                    <a href="{% url 'core:dashboard' %}" class="btn btn-secondary me-2">Cancelar</a>
                    <button type="submit" id="submit-button" class="btn btn-primary btn-lg">
                        <i class="fas fa-check me-2"></i>Concordar e Enviar Assinatura
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('signature-canvas');
    // Trata o caso de o elemento não existir para evitar erros
    if(canvas) {
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(248, 249, 250)'
        });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        document.getElementById('clear-signature').addEventListener('click', () => {
            signaturePad.clear();
        });

        document.getElementById('signature-form').addEventListener('submit', (event) => {
            if (!signaturePad.isEmpty()) {
                const hiddenInput = document.getElementById('id_assinatura_digital');
                hiddenInput.value = signaturePad.toDataURL('image/png');
            }
        });
    }
});
</script>
{% endblock %}
