
{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="card-title mb-0">{{ titulo }}</h4>
        </div>
        <div class="card-body">
            <h5 class="card-title">TERMO DE RESPONSABILIDADE SOBRE USO DE SMARTPHONE</h5>
            <p class="text-muted">Documento referente à entrega em: <strong>{{ object.data_entrega|date:"d \d\e F \d\e Y" }}</strong></p>

            <div class="row mb-4 p-3 bg-light rounded border">
                <div class="col-md-6">
                    <p><i class="fas fa-user me-2"></i><strong>Colaborador</strong></p>
                    <p><strong>Nome:</strong> {{ object.funcionario.nome_completo }}</p>
                    <p><strong>Cargo:</strong> {{ object.funcionario.cargo }}</p>
                    <p><strong>Documento:</strong> {{ object.funcionario.rg_numero }}</p>
                </div>
                <div class="col-md-6">
                    <p><i class="fas fa-mobile-alt me-2"></i><strong>Equipamento e Acessórios</strong></p>
                    <p><strong>Aparelho:</strong> {{ object.aparelho.modelo.marca }}</p>
                    <p><strong>Modelo:</strong> {{ object.aparelho.modelo }}</p>
                    <p><strong>IMEI:</strong> {{ object.aparelho.imei }}</p>
                    <p><strong>Linha:</strong> {{ object.linha.numero }}</p>
                    <p class="small text-muted">Acessórios: {{ object.aparelho.acessorios }}</p>
                </div>
            </div>

            <h6>Cláusulas e Condições</h6>
            <p class="small text-muted">
                O Celular, propriedade da CETEST MINAS ENGENHARIA E SERVIÇOS S.A, ficará sob sua inteira responsabilidade, devendo ser mantido em perfeito estado de conservação e funcionamento.
            </p>
            
            <div class="accordion" id="termoAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            <strong>Clique aqui para ler todas as cláusulas do termo</strong>
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#termoAccordion">
                        <div class="accordion-body">
                            {% for key, clause in termo_clauses.items %}
                                <p class="small"><strong>{{ key }}:</strong> {{ clause|safe }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        <hr> 
            <form method="post" id="signature-form">
                {% csrf_token %}
                {{ form.as_p }}

                <div class="mb-3">
                    <label for="signature-canvas" class="form-label fw-bold">Campo para Assinatura: </label>
                    <div class="border rounded" style="background-color: #f8f9fa;">
                        <canvas id="signature-canvas" style="width: 100%; height: 200px; cursor: crosshair;"></canvas>
                    </div>
                    <button type="button" id="clear-signature" class="btn btn-sm btn-outline-secondary mt-2">
                        <i class="fas fa-eraser me-1"></i> Limpar
                    </button>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreement-checkbox" required>
                    <label class="form-check-label fw-bold" for="agreement-checkbox">
                        Diante das cláusulas descritas, declaro que recebi os equipamentos em perfeito estado de conservação e autorizo o desconto em folha de pagamento para ligações particulares.
                    </label>
                </div>

                <div class="d-flex justify-content-end">
                    <a href="{% url 'controle_de_telefone:vinculo_list' %}" class="btn btn-secondary me-2">Cancelar</a>
                    <button type="submit" id="submit-button" class="btn btn-primary btn-lg">
                        <i class="fas fa-check me-2"></i>Concordar e Enviar Assinatura
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('signature-canvas');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(248, 249, 250)'
    });

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear(); // Limpa ao redimensionar
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    document.getElementById('clear-signature').addEventListener('click', () => {
        signaturePad.clear();
    });

    document.getElementById('signature-form').addEventListener('submit', (event) => {
        if (signaturePad.isEmpty()) {
            alert("Por favor, forneça sua assinatura.");
            event.preventDefault(); // Impede o envio do formulário
        } else {
            const hiddenInput = document.querySelector('[name="assinatura_digital_base64"]');
            // O argumento deve ser o tipo MIME, por exemplo, 'image/png'.
            hiddenInput.value = signaturePad.toDataURL('image/png');
        }
    });
});
</script>
{% endblock %}


