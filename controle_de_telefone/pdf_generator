# controle_de_telefone/pdf_generator.py

import io
from functools import partial
import logging

from django.contrib.staticfiles import finders
from django.utils.dateformat import format as date_format
from reportlab.lib import colors
from reportlab.lib.enums import TA_CENTER, TA_JUSTIFY
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import ParagraphStyle, getSampleStyleSheet
from reportlab.platypus import (Image, KeepTogether, Paragraph,
                                SimpleDocTemplate, Spacer, Table, TableStyle)
import os

# Configurar logger para logs mais detalhados
logger = logging.getLogger(__name__)

# --- Funções Auxiliares ---
def get_safe_attr(obj, attrs, default='N/A'):
    """
    Função auxiliar para obter atributos aninhados de forma segura.
    Retorna o valor padrão se qualquer atributo na cadeia for None ou vazio.
    """
    for attr in attrs.split('.'):
        try:
            obj = getattr(obj, attr, None)
            if obj is None:
                return default
        except AttributeError:
            return default
    return obj if obj else default

def get_reportlab_styles():
    """Define e retorna os estilos de parágrafo personalizados."""
    styles = getSampleStyleSheet()
    styles.add(ParagraphStyle(name='Justify', alignment=TA_JUSTIFY, fontSize=10, leading=12))
    styles.add(ParagraphStyle(name='CenterBold', alignment=TA_CENTER, fontName='Helvetica-Bold', fontSize=12))
    styles.add(ParagraphStyle(name='Center', alignment=TA_CENTER, fontSize=10))
    styles.add(ParagraphStyle(name='CenterSmall', alignment=TA_CENTER, fontSize=8))
    return styles

def create_header(styles):
    """Cria a seção do cabeçalho com o logo e o título."""
    story = []
    caminho_logo = finders.find('images/logocetest.png')
    if caminho_logo:
        story.append(Image(caminho_logo, width=100, height=40, hAlign='RIGHT'))
    else:
        logger.warning("AVISO: Logo 'images/logocetest.png' não encontrada.")
    story.append(Spacer(1, 15))
    story.append(Paragraph("TERMO DE RESPONSABILIDADE SOBRE USO DE SMARTPHONE", styles['CenterBold']))
    story.append(Spacer(1, 20))
    return story

def create_introductory_text(vinculo, styles, safe_get):
    """Cria a seção do texto introdutório do termo."""
    EMPRESA_NOME = "CETEST MINAS ENGENHARIA E SERVIÇOS S.A"
    data_entrega_f = date_format(vinculo.data_entrega, 'd \\d\\e F \\d\\e Y')
    texto_inicial = f"""
        A empresa <strong>{EMPRESA_NOME}</strong>, nesta data de <strong>{data_entrega_f}</strong>,
        entrega ao funcionário do contrato {safe_get(vinculo, 'funcionario.cliente.contrato')} um aparelho com as seguintes características:
    """
    return [Paragraph(texto_inicial, styles['Justify']), Spacer(1, 10)]

def create_item_table(vinculo, safe_get):
    """Cria a tabela de itens entregues."""
    descricao_itens = [
        ['DESCRIÇÃO DOS ITENS ENTREGUES'],
        [f"1 CELULAR {safe_get(vinculo, 'aparelho.modelo.marca.nome')} {safe_get(vinculo, 'aparelho.modelo.nome')} - IMEI: {safe_get(vinculo, 'aparelho.imei')}"],
        [f"1 CHIP {safe_get(vinculo, 'linha.plano.operadora.nome')} ({safe_get(vinculo, 'linha.numero')})"],
        [f"1 ACESSÓRIO: {safe_get(vinculo, 'aparelho.acessorios')}"],
    ]
    tabela_itens = Table(descricao_itens, colWidths=['100%'])
    tabela_itens.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#D9D9D9')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.black),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('PADDING', (0, 0), (-1, -1), 6),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
    ]))
    return [tabela_itens, Spacer(1, 10)]

def create_clauses_section(vinculo, styles, safe_get):
    """Cria a seção das cláusulas do termo."""
    EMPRESA_NOME = "CETEST MINAS ENGENHARIA E SERVIÇOS S.A"
    clausulas_intro = f"""
        O Celular de propriedade da {EMPRESA_NOME} ficará a partir desta data sob sua inteira responsabilidade, 
        devendo ser mantido em perfeito estado de conservação e funcionamento, 
        não podendo em qualquer hipótese ser cedido a terceiros sem prévia e escrita concordância da {EMPRESA_NOME},
        obedecendo as cláusulas seguintes:
    """
    story = [Paragraph(clausulas_intro, styles['Justify']), Spacer(1, 10)]
    
    clausulas = [
        ("1-", "A empresa NÃO autoriza o portador a receber e enviar conteúdo inadequado ou ilegal."),
        ("2-", "Será de responsabilidade do usuário responder por qualquer forma de comunicação que demonstre preconceito, assédio, ou participação em negócios exclusos aos propósitos da empresa."),
        ("3-", f"Fica aos cuidados do(a) Sr.(a) <strong>{safe_get(vinculo, 'funcionario.nome_completo')}</strong> a guarda e conservação do aparelho e acessórios, devendo restituí-los quando solicitado ou em caso de rescisão, sob pena de responsabilizar-se por danos."),
        ("4-", "Fica vedado permutar o equipamento ou seus acessórios. É proibida a troca do e-mail e senha fornecida pela empresa."),
        ("5-", f"A qualquer momento e sem prévio aviso, a {EMPRESA_NOME} poderá solicitar a devolução imediata da linha e do aparelho."),
    ]
    for numero, texto in clausulas:
        story.append(Paragraph(f"<strong>{numero}</strong> {texto}", styles['Justify']))
        story.append(Spacer(1, 5))
        
    return story

def create_signature_block(vinculo, styles, safe_get):
    """Cria a tabela de assinaturas, incluindo a assinatura digital."""
    EMPRESA_NOME = "CETEST MINAS ENGENHARIA E SERVIÇOS S.A"
    assinatura_funcionario = []
    
    assinatura_path = vinculo.assinatura_digital.path if vinculo.assinatura_digital else None
    
    if assinatura_path and os.path.exists(assinatura_path):
        try:
            assinatura_img = Image(assinatura_path, width=150, height=50)
            assinatura_funcionario.append(assinatura_img)
        except Exception as e:
            logger.error(f"ERRO ao carregar imagem da assinatura: {e}")
            assinatura_funcionario.append(Paragraph("________________________________", styles['Center']))
    else:
        assinatura_funcionario.append(Paragraph("________________________________", styles['Center']))
        
    assinatura_funcionario.append(Spacer(1, 2))
    assinatura_funcionario.append(Paragraph(safe_get(vinculo, 'funcionario.nome_completo'), styles['Center']))
    assinatura_funcionario.append(Paragraph(f"Doc: {safe_get(vinculo, 'funcionario.documentos.numero')}", styles['CenterSmall']))
    
    
    tabela_assinaturas = Table(
        [[assinatura_funcionario, ]], 
        colWidths=['50%', '50%']
    )
    tabela_assinaturas.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
    ]))
    
    return [Spacer(1, 25), KeepTogether([tabela_assinaturas])]

# --- Função Principal ---
def gerar_termo_responsabilidade_pdf(vinculo):
    """
    Gera o PDF do Termo de Responsabilidade para um determinado vínculo.
    """
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=72, leftMargin=72, topMargin=40, bottomMargin=40)

    styles = get_reportlab_styles()
    safe_get = partial(get_safe_attr, default='___________')
    story = []
    # 1. Cabeçalho
    story.extend(create_header(styles))
    # 2. Texto Introdutório
    story.extend(create_introductory_text(vinculo, styles, safe_get))
    # 3. Tabela de Itens
    story.extend(create_item_table(vinculo, safe_get))
    # 4. Corpo do Texto - Cláusulas
    story.extend(create_clauses_section(vinculo, styles, safe_get))
    # 5. Declaração Final
    declaracao = """
        Diante das cláusulas descritas, declaro que recebi os equipamentos em perfeito estado e autorizo o desconto em
        folha de pagamento dos valores de ligações particulares ou danos por mau uso.
    """
    story.append(Spacer(1, 10))
    story.append(Paragraph(declaracao, styles['Justify']))
    # 6. Bloco de Assinaturas
    story.extend(create_signature_block(vinculo, styles, safe_get))
    # 7. Construção do PDF
    doc.build(story)
    
    buffer.seek(0)
    return buffer

