
{% extends "base.html" %}
{% load static %}

{% block title %}Agendamento #{{ object.id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .checklist-status { padding: 5px 10px; border-radius: 4px; font-weight: bold; }
    .status-completo { background-color: #d4edda; color: #155724; }
    .status-pendente { background-color: #fff3cd; color: #856404; }
    .timeline { position: relative; padding-left: 30px; }
    .timeline-item { position: relative; margin-bottom: 20px; }
    .timeline-item::before { 
        content: ''; position: absolute; left: -20px; top: 5px; 
        width: 12px; height: 12px; border-radius: 50%; background: #007bff; 
    }
    .map-container { height: 400px; border-radius: 8px; overflow: hidden; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Agendamento #{{ object.id }}</h1>
        <div>
            <a href="{% url 'automovel:agendamento_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            {% if object.status == 'agendado' %}
            <a href="{% url 'automovel:agendamento_update' object.pk %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Editar
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Informações Principais -->
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações do Agendamento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Veículo:</strong> {{ object.carro.marca }} {{ object.carro.modelo }} - {{ object.carro.placa }}<br>
                            <strong>Funcionário:</strong> {{ object.funcionario }}<br>
                            <strong>Responsável:</strong> {{ object.responsavel }}<br>
                            <strong>CM/Contrato:</strong> {{ object.cm }}
                        </div>
                        <div class="col-md-6">
                            <strong>Data/Hora Saída:</strong> {{ object.data_hora_agenda|date:"d/m/Y H:i" }}<br>
                            <strong>Data/Hora Retorno:</strong> {{ object.data_hora_devolucao|date:"d/m/Y H:i" }}<br>
                            <strong>Status:</strong> 
                            <span class="badge bg-{% if object.status == 'finalizado' %}success{% elif object.status == 'cancelado' %}danger{% else %}warning{% endif %}">
                                {{ object.get_status_display }}
                            </span><br>
                            <strong>KM Inicial:</strong> {{ object.km_inicial|default:"-" }}<br>
                            <strong>KM Final:</strong> {{ object.km_final|default:"-" }}
                        </div>
                    </div>
                    
                    {% if object.descricao %}
                    <div class="mt-3">
                        <strong>Descrição:</strong>
                        <p class="mb-0">{{ object.descricao }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Checklists -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Checklists</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 text-center">
                            <h6>Checklist de Saída</h6>
                            {% if checklist_saida %}
                                <span class="checklist-status status-completo">COMPLETO</span>
                                <a href="{% url 'automovel:checklist_detail' checklist_saida.pk %}" 
                                   class="btn btn-sm btn-outline-primary mt-2">
                                    Ver Detalhes
                                </a>
                            {% else %}
                                <span class="checklist-status status-pendente">PENDENTE</span>
                                {% if object.status == 'agendado' %}
                                <a href="{% url 'automovel:checklist_create' object.pk %}?tipo=saida" 
                                   class="btn btn-sm btn-success mt-2">
                                    Realizar Checklist
                                </a>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="col-md-6 text-center">
                            <h6>Checklist de Retorno</h6>
                            {% if checklist_retorno %}
                                <span class="checklist-status status-completo">COMPLETO</span>
                                <a href="{% url 'automovel:checklist_detail' checklist_retorno.pk %}" 
                                   class="btn btn-sm btn-outline-primary mt-2">
                                    Ver Detalhes
                                </a>
                            {% else %}
                                <span class="checklist-status status-pendente">PENDENTE</span>
                                {% if object.status == 'em_andamento' and checklist_saida %}
                                <a href="{% url 'automovel:checklist_create' object.pk %}?tipo=retorno" 
                                   class="btn btn-sm btn-success mt-2">
                                    Realizar Checklist
                                </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rastreamento -->
            {% if object.status == 'em_andamento' %}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Rastreamento em Tempo Real</h5>
                </div>
                <div class="card-body">
                    <div id="map" class="map-container mb-3"></div>
                    <div class="text-center">
                        <a href="{% url 'automovel:rastreamento_map' object.pk %}" 
                           class="btn btn-primary">
                            <i class="bi bi-map"></i> Ver Mapa Completo
                        </a>
                        <button id="iniciarRastreamento" class="btn btn-success">
                            <i class="bi bi-play-circle"></i> Iniciar Rastreamento
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Histórico e Sidebar -->
        <div class="col-md-4">
            <!-- Histórico do Veículo -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Histórico do Veículo</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for historico in historico_agendamentos %}
                        <div class="timeline-item">
                            <strong>#{{ historico.id }} - {{ historico.funcionario }}</strong><br>
                            <small class="text-muted">
                                {{ historico.data_hora_agenda|date:"d/m/Y" }} - 
                                {{ historico.get_status_display }}
                            </small>
                            {% if historico.descricao %}
                            <p class="mb-1 small">{{ historico.descricao|truncatewords:10 }}</p>
                            {% endif %}
                            <a href="{% url 'automovel:agendamento_detail' historico.pk %}" 
                               class="btn btn-sm btn-outline-secondary mt-1">
                                Ver Detalhes
                            </a>
                        </div>
                        {% empty %}
                        <p class="text-muted">Nenhum histórico anterior</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Ações Rápidas -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Ações Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if object.status == 'agendado' %}
                        <a href="{% url 'automovel:checklist_create' object.pk %}?tipo=saida" 
                           class="btn btn-success">
                            <i class="bi bi-clipboard-check"></i> Checklist Saída
                        </a>
                        {% endif %}
                        
                        {% if object.status == 'em_andamento' %}
                        <a href="{% url 'automovel:checklist_create' object.pk %}?tipo=retorno" 
                           class="btn btn-warning">
                            <i class="bi bi-clipboard-check"></i> Checklist Retorno
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'automovel:gerar_relatorio_word' 'checklist' object.pk %}" 
                           class="btn btn-info">
                            <i class="bi bi-download"></i> Exportar Relatório
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
{% if object.status == 'em_andamento' %}
// Mapa de rastreamento
var map = L.map('map').setView([-23.5505, -46.6333], 13); // Centro em São Paulo

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Rastreamento em tempo real
$('#iniciarRastreamento').click(function() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                
                // Enviar para o servidor
                $.ajax({
                    url: '{% url "automovel:rastreamento_create" %}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        agendamento_id: {{ object.id }},
                        latitude: lat,
                        longitude: lng,
                        velocidade: position.coords.speed || null
                    }),
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                // Atualizar mapa
                map.setView([lat, lng], 13);
                L.marker([lat, lng]).addTo(map)
                    .bindPopup('Posição atual: ' + new Date().toLocaleString())
                    .openPopup();
            },
            function(error) {
                alert('Erro ao obter localização: ' + error.message);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
        
        $(this).prop('disabled', true).text('Rastreamento Ativo');
    } else {
        alert('Geolocalização não suportada pelo navegador.');
    }
});
{% endif %}
</script>
{% endblock %}