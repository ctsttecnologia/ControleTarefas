{% extends "base.html" %}

{% block title %}{{ titulo_pagina }}{% endblock %}

{% block content %}
<div class="container py-2">
        
    <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">

        <h1 class="h2 mb-0">{{ titulo_pagina }}</h1>
        
        <div class="btn-group">
            
            <a href="{% url 'seguranca_trabalho:dashboard' %}" class="btn btn-danger btn-glow" title="Painel SST">
                <i class="bi bi-speedometer2 me-1"></i>Painel SST
            </a>
            
            <a href="{% url 'gestao_riscos:registrar_incidente' %}" class="btn btn-danger btn-glow" title="Registrar Incidente">
                <i class="bi bi-exclamation-octagon-fill me-1"></i> Registrar Incidente
            </a>
        
            <a href="{% url 'gestao_riscos:agendar_inspecao' %}" class="btn btn-danger btn-glow" title="Agendar Inspeção">
               <i class="bi bi-calendar-plus me-1"></i> Agendar Inspeção
            </a>

            <a href="{% url 'gestao_riscos:calendario' %}" class="btn btn-secondary">
                <i class="bi bi-calendar me-1"></i> Voltar ao Calendário
            </a>
            
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item" href="{% url 'gestao_riscos:calendario' %}" title="Ver Calendário">
                        <i class="bi bi-calendar3 me-2"></i> Calendário de Inspeções
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{% url 'gestao_riscos:agendar_inspecao' %}" title="Agendar inspeção manual">
                        <i class="bi bi-calendar-plus me-2"></i> Agendar Inspeção Manual
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="{% url 'gestao_riscos:lista_inspecoes_propostas' %}" title="Inspeções Propostas">
                        <i class="bi bi-bell-fill me-2"></i> Inspeções Propostas
                        
                        {% comment %} Adiciona um badge se houver propostas pendentes {% endcomment %}
                        {% if inspecoes_propostas.count > 0 %}
                            <span class="badge rounded-pill bg-warning text-dark ms-2">
                                {{ inspecoes_propostas.count }}
                            </span>
                        {% endif %}
                    </a>
                </li>
            </ul>
        </div>
    </header>

    <div class="row g-4">
    
        <div class="col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header text-bg-danger bg-opacity-75">
                    <h5 class="mb-0 fw-semibold"><i class="bi bi-exclamation-octagon-fill me-2"></i>Últimos Incidentes Registrados</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Descrição</th>
                                <th scope="col">Setor</th>
                                <th scope="col" class="text-center">Tipo</th>
                                <th scope="col">Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% comment %} Este loop 'incidentes' está correto {% endcomment %}
                            {% for incidente in incidentes %}
                                <tr>
                                    <td class="fw-semibold">{{ incidente.descricao }}</td>
                                    <td>{{ incidente.get_setor_display }}</td>
                                    <td class="text-center"><span class="badge rounded-pill text-bg-secondary">{{ incidente.get_tipo_incidente_display }}</span></td>
                                    <td>{{ incidente.data_ocorrencia|date:"d/m/Y H:i" }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center p-5">
                                        <div class="text-muted">
                                            <i class="bi bi-shield-check fs-1"></i>
                                            <h5 class="mt-3">Nenhum incidente recente!</h5>
                                            <p class="small">Continue mantendo o ambiente de trabalho seguro.</p>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
        
            <div class="card shadow mb-4">
                <div class="card-header text-bg-primary bg-opacity-75 text-white">
                    <h5 class="mb-0 fw-semibold"><i class="bi bi-clipboard2-pulse-fill me-2"></i>Inspeções Pendentes (Confirmadas)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <tbody>
                            {% comment %} 
                               1: Loop alterado de 'inspecoes' para 'inspecoes_pendentes'
                            {% endcomment %}
                            {% for inspecao in inspecoes_pendentes %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ inspecao.equipamento.nome }}</div>
                                        <div class="small text-muted">
                                            {% comment %} 
                                               2: Campo 'inspetor' alterado para 'responsavel'
                                            {% endcomment %}
                                            Responsável: {{ inspecao.responsavel.get_full_name|default:"Não atribuído" }}
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        {% comment %} 
                                          3: Removida lógica de 'data_atual' que causava erro
                                        {% endcomment %}
                                        {{ inspecao.data_agendada|date:"d/m/Y" }}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center p-5">
                                        <div class="text-muted">
                                            <i class="bi bi-calendar2-check-fill fs-1"></i>
                                            <h5 class="mt-3">Nenhuma inspeção pendente!</h5>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card shadow mb-4">
                <div class="card-header text-bg-warning bg-opacity-75 text-dark">
                    <h5 class="mb-0 fw-semibold"><i class="bi bi-bell-fill me-2"></i>Inspeções Propostas (Aguardando Ação)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <tbody>
                            {% comment %} 
                              Loop para a variável 'inspecoes_propostas'
                            {% endcomment %}
                            {% for inspecao in inspecoes_propostas %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ inspecao.entrega_epi.equipamento.nome }}</div>
                                        <div class="small text-muted">
                                            Item: {{ inspecao.entrega_epi.numero_serie|default:"N/A" }}
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        {{ inspecao.data_agendada|date:"d/m/Y" }}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center p-5">
                                        <div class="text-muted">
                                            <i class="bi bi-patch-check-fill fs-1"></i>
                                            <h5 class="mt-3">Nenhuma proposta automática.</h5>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                 <div class="card-footer text-center">
                    <a href="{% url 'gestao_riscos:lista_inspecoes_propostas' %}" class="btn btn-sm btn-outline-dark">
                        Ver todas e confirmar
                    </a>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}


