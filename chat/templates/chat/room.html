
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12 col-md-8 offset-md-2">

            <div class="card">
                <div class="card-header bg-primary text-white">
                    {% if room.room_type == 'individual' %}
                        Conversa com: 
                        {% if room.user1 == request.user %}
                            {{ room.user2.username }}
                        {% else %}
                            {{ room.user1.username }}
                        {% endif %}
                    {% elif room.room_type == 'task' %}
                        Chat da Tarefa: {{ room.task.titulo }}
                    {% else %}
                        Sala de Grupo: {{ room.name }} ({{ room.participants.count }} membros)
                    {% endif %}
                </div>
                
                <div class="card-body" id="chat-log" style="height: 500px; overflow-y: scroll;">
                    {% for msg in messages %}
                        <div class="mb-2 {% if request.user == msg.user %}text-end{% endif %}">
                            <small class="text-muted">{{ msg.user.username }} - {{ msg.timestamp|date:"H:i" }}</small><br>
                            {% if msg.image %}
                                <img src="{{ msg.get_image_url }}" class="img-fluid" style="max-width: 200px; height: auto;" alt="Imagem do Chat">
                            {% elif msg.content %}
                                <span class="badge bg-secondary p-2">{{ msg.content|urlize }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="card-footer">
                    <div class="input-group">
                        <input type="file" id="image-upload-input" class="form-control" accept="image/*" style="display: none;">
                        <button class="btn btn-outline-secondary" type="button" id="upload-image-btn">
                            <i class="bi bi-image"></i> </button>
                        <input type="text" id="chat-message-input" class="form-control" placeholder="Digite sua mensagem ou emoji...">
                        <button class="btn btn-success" id="chat-message-submit">Enviar</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{{ room.id|json_script:"json-room-id" }}
{{ request.user.username|json_script:"json-username" }}
{{ current_user_id|json_script:"json-current-user-id" }}
{% endblock %}


{% block extra_js %}
<script>
    // --- LÓGICA DO WEBSOCKET ---

    // 1. Pega os dados do Django
    const roomId = JSON.parse(document.getElementById('json-room-id').textContent);
    const userName = JSON.parse(document.getElementById('json-username').textContent);
    const currentUserId = JSON.parse(document.getElementById('json-current-user-id').textContent);

    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-message-input');
    const chatSubmit = document.getElementById('chat-message-submit');
    const imageUploadInput = document.getElementById('image-upload-input');
    const uploadImageBtn = document.getElementById('upload-image-btn');

    // Função helper para rolar o chat para o final
    function scrollToBottom() {
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // 2. Define o protocolo WebSocket (wss:// em produção!)
    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const chatSocket = new WebSocket(
        wsProtocol + '://' +
        window.location.host +
        '/ws/chat/' +
        roomId + '/'
    );

    // 3. Handler: O que fazer quando uma mensagem CHEGA do servidor (Consumer)
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const imageUrl = data.image_url;
        const username = data.username;
        const timestamp = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); // Formata hora

        // Cria o elemento da mensagem (usando classes Bootstrap)
        const messageElement = document.createElement('div');
        messageElement.classList.add('mb-2');
        
        // Alinha à direita se for a mensagem do usuário atual
        if (username === userName) {
            messageElement.classList.add('text-end'); 
        }

        // Adiciona informações de cabeçalho
        const header = document.createElement('small');
        header.classList.add('text-muted');
        header.innerHTML = `${username} - ${timestamp}`;
        messageElement.appendChild(header);
        messageElement.appendChild(document.createElement('br')); // Quebra de linha

        if (imageUrl) {
            // Se for uma imagem
            const img = document.createElement('img');
            img.src = imageUrl;
            img.classList.add('img-fluid');
            img.style.maxWidth = '200px';
            img.style.height = 'auto';
            img.alt = 'Imagem do Chat';
            messageElement.appendChild(img);
        } else if (message) {
            // Se for texto/emoji
            const contentSpan = document.createElement('span');
            contentSpan.classList.add('badge', 'bg-secondary', 'p-2');
            contentSpan.textContent = message; // textContent para segurança contra XSS
            messageElement.appendChild(contentSpan);
        }

        chatLog.appendChild(messageElement);
        scrollToBottom();
    };

    // 4. Handler: O que fazer se a conexão fechar
    chatSocket.onclose = function(e) {
        console.error('Socket de chat fechado inesperadamente');
        // Você pode tentar reconectar aqui
    };

    // 5. Handler: O que fazer quando o usuário ENVIA uma mensagem de texto
    chatSubmit.onclick = function(e) {
        const message = chatInput.value;
        
        if (message.trim() === '') return; 

        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message
        }));

        chatInput.value = ''; // Limpa o input
        chatInput.focus();
    };

    // Permite enviar com "Enter"
    chatInput.onkeyup = function(e) {
        if (e.key === 'Enter') {
            chatSubmit.click();
        }
    };

    // 6. Lógica para Upload de Imagens
    uploadImageBtn.onclick = function() {
        imageUploadInput.click(); // Simula o clique no input de arquivo oculto
    };

    imageUploadInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            // Verifica o tamanho do arquivo (ex: máximo 5MB)
            if (file.size > 5 * 1024 * 1024) { 
                alert('A imagem é muito grande (máx 5MB).');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Image = event.target.result; // Data URL em Base64
                chatSocket.send(JSON.stringify({
                    'type': 'image_message',
                    'image': base64Image
                }));
            };
            reader.readAsDataURL(file); // Lê o arquivo como Base64
        }
        imageUploadInput.value = ''; // Limpa o input para permitir upload do mesmo arquivo novamente
    };


    // Rola para baixo no carregamento inicial da página
    scrollToBottom();

</script>
{% endblock %}
