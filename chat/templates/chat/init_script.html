
<!-- chat/templates/chat/init_script.html -->
{% load static %}

<script>
(function() {
    // ‚ö° GUARDA CONTRA DUPLICA√á√ÉO
    if (window._chatInitialized) {
        console.warn('‚ö†Ô∏è Chat j√° foi inicializado. Ignorando duplica√ß√£o.');
        return;
    }
    window._chatInitialized = true;

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üé¨ Iniciando sistema de chat v4.0...');

        const currentUserId = "{{ request.user.id }}";

        // Valida√ß√£o de autentica√ß√£o
        if (!currentUserId || currentUserId === 'None' || currentUserId === 'AnonymousUser') {
            console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado, chat n√£o ser√° carregado');
            return;
        }

        // Verifica se j√° foi inicializado
        if (window.chatManager) {
            console.warn('‚ö†Ô∏è ChatManager j√° existe. Ignorando.');
            return;
        }

        // URLs do chat (via context processor ou fallback)
        let chatUrls;
        try {
            const contextUrls = {{ chat_urls|safe }};
            if (contextUrls && Object.keys(contextUrls).length > 0 && contextUrls.active_room_list) {
                console.log('‚úÖ Usando URLs do context processor');
                chatUrls = contextUrls;
            } else {
                throw new Error('Context processor vazio');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Context processor falhou, usando URLs diretas:', error);
            chatUrls = {
                active_room_list:   "{% url 'chat:get_active_room_list' %}",
                user_list:          "{% url 'chat:get_user_list' %}",
                task_list:          "{% url 'chat:get_task_list' %}",
                create_group_url:   "{% url 'chat:create_group' %}",
                upload_image_url:   "{% url 'chat:chat_image_upload' %}",
                start_dm_base:      "{% url 'chat:start_dm' 0 %}",
                get_task_chat_base: "{% url 'chat:get_task_chat' 0 %}"
            };
        }

        console.log('üìã URLs finais do chat:', chatUrls);

        // Valida√ß√£o final das URLs
        if (!chatUrls || !chatUrls.active_room_list) {
            console.error('‚ùå URLs do chat inv√°lidas');
            showChatErrorMessage('Configura√ß√£o de URLs inv√°lida');
            return;
        }

        // Performance tracking
        const chatLoadStart = performance.now();

        // Carregamento do chat
        loadChatSystem();

        function loadChatSystem() {
            console.log('üì¶ Iniciando carregamento do chat...');

            // Verifica se o script j√° foi carregado
            if (typeof window.ChatManager !== 'undefined') {
                console.log('‚úÖ ChatManager j√° dispon√≠vel, inicializando...');
                initializeChatManager();
                return;
            }

            const script = document.createElement('script');
            script.src = "{% static 'js/chat.js' %}?v=" + Date.now();
            script.async = false;
            
            script.onload = () => {
                if (typeof window.ChatManager !== 'undefined') {
                    console.log('‚úÖ chat.js carregado com sucesso');
                    initializeChatManager();
                } else {
                    console.error('‚ùå ChatManager n√£o encontrado ap√≥s carregar chat.js');
                    showChatErrorMessage('Sistema de chat corrompido');
                }
            };
            
            script.onerror = () => {
                console.error('‚ùå Falha ao carregar chat.js');
                showChatErrorMessage('N√£o foi poss√≠vel carregar o sistema de chat');
            };
            
            document.head.appendChild(script);
        }

        function initializeChatManager() {
            try {
                window.chatManager = new window.ChatManager(chatUrls, currentUserId);
                const loadTime = (performance.now() - chatLoadStart).toFixed(2);
                console.log(`üéâ Chat inicializado! Tempo: ${loadTime}ms`);
                
                document.dispatchEvent(new CustomEvent('chatSystemReady', {
                    detail: { chatManager: window.chatManager, loadTime }
                }));
            } catch (error) {
                console.error('‚ùå Erro ao instanciar ChatManager:', error);
                showChatErrorMessage('Falha ao iniciar o chat: ' + error.message);
            }
        }

        function showChatErrorMessage(details = '') {
            const existingError = document.getElementById('chat-error-notification');
            if (existingError) existingError.remove();

            const errorDiv = document.createElement('div');
            errorDiv.id = 'chat-error-notification';
            errorDiv.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; background: #dc3545; color: white; padding: 15px; border-radius: 8px; z-index: 999999; font-family: system-ui; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <div style="font-size: 20px;">‚ùå</div>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 5px;">Chat Indispon√≠vel</strong>
                            <p style="margin: 0 0 10px 0; font-size: 13px; line-height: 1.4;">
                                ${details || 'Sistema de chat com problemas.'}
                            </p>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="location.reload()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üîÑ Recarregar
                                </button>
                                <button onclick="this.closest('#chat-error-notification').remove()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 15000);
        }

        // Timeout global de seguran√ßa
        setTimeout(() => {
            if (!window.chatManager) {
                console.warn('‚è∞ Timeout: Chat n√£o carregou em 20 segundos');
                showChatErrorMessage('Timeout no carregamento');
            }
        }, 20000);
    });
})();
</script>

