
{% load widget_tweaks %}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de EPI</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <link rel="stylesheet" href="{% static 'cssepi/fichastyles.css' %}">
</head>
<body>
    {% include 'includes/header.html' %}

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div class="container">
        <div class="painel">  
            <a href="{% url 'epi:listar_fichas' %}" class="btn btn-primary">
                <i class="fas fa-save me-2"></i> Minhas Fichas de EPI
            </a>
        </div>
        
        <div class="painel2">
            <form method="post" enctype="multipart/form-data" id="fichaForm" novalidate>
                {% csrf_token %}
                
                <h3 class="mb-3 text-center">Ficha de EPI</h3>
                
                <!-- Seção de Dados de Identificação -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Dados de Identificação</h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6 form-group">
                                <label for="id_registro" class="form-label">Registro/Mátricula:</label>
                                {% render_field form_ficha.registro class="form-control" id="id_registro" required="required" %}
                                <div class="invalid-feedback">Por favor, informe o registro</div>
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="id_empregado" class="form-label">Nome do Empregado:</label>
                                {% render_field form_ficha.empregado class="form-control" id="id_empregado" readonly="readonly" %}
                                <div class="invalid-feedback">Por favor, informe o registro primeiro</div>
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="id_cargo" class="form-label">Cargo:</label>
                                {% render_field form_ficha.cargo class="form-control" id="id_cargo" %}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="id_admissao" class="form-label">Data de Admissão:</label>
                                {% render_field form_ficha.admissao class="form-control" type="date" id="id_admissao" %}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="id_contrato" class="form-label">Contrato:</label>
                                {% render_field form_ficha.contrato class="form-control" id="id_contrato" %}
                            </div>
                            
                            <div class="col-md-6 form-group">
                                <label for="id_local_data" class="form-label">Local e Data:</label>
                                {% render_field form_ficha.local_data class="form-control" id="id_local_data" %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Termo de Compromisso -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Termo de Compromisso</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <p>Eu, <strong id="nomeEmpregado"></strong>,</p>
                            
                            <div class="signature-container mb-3">
                                <label class="form-label">Assinatura do Empregado:</label>
                                <div class="signature-wrapper border rounded p-2 bg-light">
                                    <canvas class="signature-pad" id="signaturePadEmpregado" width="400" height="200"></canvas>
                                    <input type="hidden" name="assinatura_empregado" id="assinaturaEmpregado" required>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="clearSignatureEmpregado">
                                        <i class="bi bi-eraser"></i> Limpar Assinatura
                                    </button>
                                </div>
                                <div class="invalid-feedback">Assinatura obrigatória</div>
                            </div>
                            
                            <p>Declaro que recebi de CETEST MINAS ENGENHARIA E SERVIÇOS S/A os Equipamentos de Proteção Individual - EPI's relacionados abaixo, comprometendo-me a:</p>
                            <ol>
                                <li>Usá-los durante o trabalho, zelando por sua guarda e conservação, devolvendo-os quando se tornarem impróprios para uso e/ou no meu desligamento da CETEST MINAS ou do respectivo contrato;</li>
                                <li>Em caso de perda, mau uso, extravio ou inutilização proposital do EPI recebido, assumo a responsabilidade quanto à restituição do seu valor atualizado, conforme autorização de débito por mim assinada.</li>
                            </ol>
                            
                            <p>Declaro ainda ter recebido no ato de minha admissão e no ato do recebimento:</p>
                            <ol>
                                <li>Treinamento básico e instruções prévias sobre a forma de utilização e guarda dos EPI's recebidos;</li>
                                <li>Instruções sobre os riscos a que estou exposto em minha área de trabalho, bem como sua prevenção.</li>
                                <li>Estou ciente de que o não uso dos EPI's constitui ato faltoso conforme artigo 158 da CLT.</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Itens de EPI -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Itens de EPI</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive mb-4">
                            <table class="table table-striped" id="selectedEpisTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Equipamento</th>
                                        <th>CA</th>
                                        <th>Quantidade</th>
                                        <th>Data Recebimento</th>
                                        <th>Assinatura</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Itens serão adicionados dinamicamente aqui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-5 form-group">
                                <label for="equipamentoSelect" class="form-label">Equipamento:</label>
                                <select class="form-select equipamento-select" id="equipamentoSelect" required>
                                    <option value="" selected disabled>Selecione um equipamento</option>
                                    {% for equipamento in equipamentos %}
                                        <option value="{{ equipamento.id }}" 
                                                data-ca="{{ equipamento.codigo_CA|default:'N/A' }}"
                                                data-validade="{{ equipamento.data_validade|date:'Y-m-d'|default:'' }}">
                                            {{ equipamento.nome_equipamento }} - {{ equipamento.get_tipo_display }}
                                        </option>
                                    {% empty %}
                                        <option value="" disabled>Nenhum equipamento cadastrado</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-2 form-group">
                                <label for="quantidadeInput" class="form-label">Quantidade:</label>
                                <input type="number" class="form-control" id="quantidadeInput" min="1" value="1" required>
                            </div>
                            
                            <div class="col-md-3 form-group">
                                <label for="dataRecebimentoInput" class="form-label">Data de Recebimento:</label>
                                <input type="date" class="form-control" id="dataRecebimentoInput" required>
                            </div>
                            
                            <div class="col-md-2 form-group d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" id="addEpiBtn">
                                    <i class="bi bi-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campo oculto para armazenar os dados dos itens de EPI -->
                <input type="hidden" name="epi_items" id="epiItemsData" value="[]">
                
                <!-- Botão de Submissão -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="fas fa-save"> </i> Salvar Ficha
                    </button>
                </div>
                
                <!-- Mensagens de feedback -->
                <div id="formMessages" class="mt-3"></div>
            </form>
        </div>
    </div>

    {% include 'includes/footer.html' %}

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <script>
    $(document).ready(function() {
        // Variáveis globais
        let canvasEmpregado, signaturePadEmpregado;
        let epiItems = [];
        const hoje = new Date().toISOString().split('T')[0];
        
        // Inicialização
        function init() {
            initSignaturePad();
            initEquipamentoSelect();
            initDateInputs();
            setupEventListeners();
        }
        
        // Inicializa o pad de assinatura
        function initSignaturePad() {
            canvasEmpregado = document.getElementById('signaturePadEmpregado');
            if (canvasEmpregado) {
                signaturePadEmpregado = new SignaturePad(canvasEmpregado, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)'
                });
                resizeCanvas(canvasEmpregado);
                window.addEventListener('resize', () => resizeCanvas(canvasEmpregado));
            }
        }
        
        // Ajusta o canvas para alta resolução
        function resizeCanvas(canvas) {
            if (!canvas) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            if (signaturePadEmpregado) signaturePadEmpregado.clear();
        }
        
        // Inicializa o select de equipamentos
        function initEquipamentoSelect() {
            if ($('#equipamentoSelect option').length > 1) {
                new Choices('#equipamentoSelect', {
                    removeItemButton: true,
                    searchEnabled: true,
                    placeholder: true,
                    shouldSort: false,
                    classNames: {
                        containerOuter: 'choices',
                        containerInner: 'choices__inner',
                        input: 'choices__input',
                        item: 'choices__item',
                        button: 'choices__button'
                    }
                });
            }
        }
        
        // Configura os inputs de data
        function initDateInputs() {
            $('#dataRecebimentoInput').val(hoje).attr('max', hoje);
        }
        
        // Configura os event listeners
        function setupEventListeners() {
            // Autocomplete do registro
            $('#id_registro').on('change', buscarFuncionario);
            
            // Limpar assinatura
            $('#clearSignatureEmpregado').on('click', limparAssinaturaEmpregado);
            
            // Adicionar item de EPI
            $('#addEpiBtn').on('click', adicionarItemEPI);
            
            // Remover item de EPI (delegação de evento)
            $('#selectedEpisTable').on('click', '.remove-epi-btn', removerItemEPI);
            
            // Validação do formulário
            $('#fichaForm').on('submit', submeterFormulario);
            
            // Atualizar assinatura do empregado
            if (canvasEmpregado) {
                canvasEmpregado.addEventListener('mouseup', atualizarAssinaturaEmpregado);
            }
        }
        
        // Busca dados do funcionário
        function buscarFuncionario() {
            const registro = $(this).val().trim();
            if (registro.length < 3) return;
            
            showLoading(true);
            
            $.getJSON(`/api/funcionarios/?registro=${registro}`)
                .done(function(data) {
                    if (data && data.nome) {
                        $('#id_empregado').val(data.nome);
                        $('#id_cargo').val(data.cargo || '');
                        $('#id_admissao').val(data.admissao || '');
                        $('#nomeEmpregado').text(data.nome);
                    } else {
                        showMessage('Funcionário não encontrado', 'warning');
                    }
                })
                .fail(function() {
                    showMessage('Erro ao buscar dados do funcionário', 'danger');
                })
                .always(function() {
                    showLoading(false);
                });
        }
        
        // Adiciona item de EPI à tabela
        function adicionarItemEPI() {
            const equipamentoSelect = $('#equipamentoSelect');
            const equipamentoId = equipamentoSelect.val();
            const equipamentoOption = equipamentoSelect.find('option:selected');
            
            if (!equipamentoId) {
                showMessage('Selecione um equipamento', 'danger');
                return;
            }
            
            const quantidade = parseInt($('#quantidadeInput').val());
            if (isNaN(quantidade) || quantidade < 1) {
                showMessage('Informe uma quantidade válida', 'danger');
                return;
            }
            
            const dataRecebimento = $('#dataRecebimentoInput').val();
            if (!dataRecebimento) {
                showMessage('Informe a data de recebimento', 'danger');
                return;
            }
            
            if (dataRecebimento > hoje) {
                showMessage('Data de recebimento não pode ser futura', 'danger');
                return;
            }
            
            // Verifica validade do equipamento
            const dataValidade = equipamentoOption.data('validade');
            if (dataValidade && dataValidade < dataRecebimento) {
                showMessage('Este equipamento está vencido', 'warning');
                return;
            }
            
            // Verifica se já foi adicionado
            if (epiItems.some(item => item.equipamento_id == equipamentoId)) {
                showMessage('Este equipamento já foi adicionado', 'warning');
                return;
            }
            
            // Cria o item
            const itemId = Date.now();
            const newItem = {
                id: itemId,
                equipamento_id: equipamentoId,
                equipamento_nome: equipamentoOption.text().split(' - ')[0],
                ca: equipamentoOption.data('ca') || 'N/A',
                quantidade: quantidade,
                data_recebimento: dataRecebimento,
                data_validade: dataValidade || '',
                assinatura: null
            };
            
            // Adiciona ao array
            epiItems.push(newItem);
            atualizarItensEPI();
            
            // Adiciona à tabela
            const newRow = `
                <tr data-item-id="${itemId}">
                    <td>${newItem.equipamento_nome}</td>
                    <td>${newItem.ca}</td>
                    <td>${newItem.quantidade}</td>
                    <td>${formatarData(newItem.data_recebimento)}</td>
                    <td>
                        <div class="signature-item-container" id="signatureContainer-${itemId}">
                            <canvas class="signature-pad-item" width="200" height="100"></canvas>
                            <input type="hidden" class="signature-data" id="signatureData-${itemId}">
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2 clear-signature-btn">
                                <i class="bi bi-eraser"></i> Limpar
                            </button>
                        </div>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger remove-epi-btn">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#selectedEpisTable tbody').append(newRow);
            initItemSignature(itemId);
            
            // Limpa os campos
            equipamentoSelect.val('').trigger('change');
            $('#quantidadeInput').val(1);
            
            showMessage('Equipamento adicionado com sucesso', 'success');
        }
        
        // Inicializa a assinatura para um item de EPI
        function initItemSignature(itemId) {
            const canvas = $(`#signatureContainer-${itemId} canvas`)[0];
            const signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            // Botão para limpar a assinatura
            $(`#signatureContainer-${itemId} .clear-signature-btn`).on('click', function() {
                signaturePad.clear();
                $(`#signatureData-${itemId}`).val('');
                atualizarAssinaturaItem(itemId, null);
            });
            
            // Atualiza quando a assinatura é feita
            canvas.addEventListener('mouseup', function() {
                if (!signaturePad.isEmpty()) {
                    const signatureData = canvas.toDataURL();
                    $(`#signatureData-${itemId}`).val(signatureData);
                    atualizarAssinaturaItem(itemId, signatureData);
                }
            });
        }
        
        // Remove item de EPI
        function removerItemEPI() {
            const itemId = $(this).closest('tr').data('item-id');
            epiItems = epiItems.filter(item => item.id != itemId);
            $(this).closest('tr').remove();
            atualizarItensEPI();
            showMessage('Equipamento removido', 'info');
        }
        
        // Atualiza a assinatura de um item
        function atualizarAssinaturaItem(itemId, signatureData) {
            const itemIndex = epiItems.findIndex(item => item.id == itemId);
            if (itemIndex !== -1) {
                epiItems[itemIndex].assinatura = signatureData;
                atualizarItensEPI();
            }
        }
        
        // Atualiza a assinatura do empregado
        function atualizarAssinaturaEmpregado() {
            if (signaturePadEmpregado && !signaturePadEmpregado.isEmpty()) {
                $('#assinaturaEmpregado').val(canvasEmpregado.toDataURL());
            }
        }
        
        // Limpa a assinatura do empregado
        function limparAssinaturaEmpregado() {
            if (signaturePadEmpregado) {
                signaturePadEmpregado.clear();
                $('#assinaturaEmpregado').val('');
            }
        }
        
        // Atualiza o campo hidden com os itens
        function atualizarItensEPI() {
            $('#epiItemsData').val(JSON.stringify(epiItems));
        }
        
        // Formata data para exibição
        function formatarData(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        // Exibe mensagens para o usuário
        function showMessage(message, type) {
            const messagesDiv = $('#formMessages');
            messagesDiv.html(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `);
            
            setTimeout(() => {
                messagesDiv.find('.alert').alert('close');
            }, 5000);
        }
        
        // Mostra/oculta o loading
        function showLoading(show) {
            $('#loadingOverlay').toggle(show);
        }
        
        // Validação do formulário
        function submeterFormulario(e) {
            e.preventDefault();
            
            // Validação básica
            let isValid = true;
            const form = this;
            
            // Valida campos obrigatórios
            $(form).find('[required]').each(function() {
                if (!$(this).val()) {
                    $(this).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            // Valida assinatura do empregado
            if (signaturePadEmpregado && signaturePadEmpregado.isEmpty()) {
                $('#assinaturaEmpregado').addClass('is-invalid');
                showMessage('Assine o termo de responsabilidade', 'danger');
                isValid = false;
            } else {
                $('#assinaturaEmpregado').removeClass('is-invalid');
            }
            
            // Valida itens de EPI
            if (epiItems.length === 0) {
                showMessage('Adicione pelo menos um item de EPI', 'danger');
                isValid = false;
            }
            
            // Valida assinaturas dos itens
            const itensSemAssinatura = epiItems.filter(item => !item.assinatura);
            if (itensSemAssinatura.length > 0) {
                showMessage(`Há ${itensSemAssinatura.length} item(s) sem assinatura`, 'danger');
                isValid = false;
            }
            
            if (!isValid) {
                showMessage('Corrija os erros antes de enviar', 'danger');
                return;
            }
            
            // Atualiza campo hidden com os itens
            atualizarItensEPI();
            
            // Envia o formulário
            enviarFormulario(form);
        }
        
        // Envia o formulário via AJAX
        function enviarFormulario(form) {
            showLoading(true);
            $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');
            
            const formData = new FormData(form);
            
            $.ajax({
                url: $(form).attr('action'),
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        showMessage('Ficha salva com sucesso! Redirecionando...', 'success');
                        setTimeout(() => {
                            window.location.href = response.redirect_url || "{% url 'epi:listar_fichas' %}";
                        }, 2000);
                    } else {
                        showMessage(response.message || 'Erro ao salvar ficha', 'danger');
                        $('#submitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Ficha');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Erro ao enviar formulário';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showMessage(errorMsg, 'danger');
                    $('#submitBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Ficha');
                },
                complete: function() {
                    showLoading(false);
                }
            });
        }
        
        // Inicializa a aplicação
        init();
    });
    </script>

    <style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .signature-pad {
        width: 100%;
        height: 100%;
        border: 1px solid #ddd;
        background-color: white;
    }
    
    .signature-pad-item {
        width: 100%;
        height: 100px;
        border: 1px solid #ddd;
        background-color: white;
    }
    
    .signature-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .signature-item-container {
        max-width: 300px;
    }
    
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
    
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
    </style>
</body>
</html>