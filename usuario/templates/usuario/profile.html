
{% extends 'base.html' %}
{% load static %}

{% block title %}Perfil do Usuário{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/usuario/profile.css' %}"> 
{% endblock %}

{% block body_class %}profile-page-background{% endblock %}

{% block extra_head %}
<style>
.profile-page-background {
    background-image: url('{% static "images/background.png" %}');
    background-position: center center;
    background-attachment: fixed;
    background-size: cover;
    background-repeat: no-repeat;
}
</style>
{% endblock %}

{% block content %}

<div class="container py-5">
    <div class="row g-4" id="card-container">

        {# O loop do Django vai renderizar apenas os cards permitidos #}
        {% for card in allowed_cards %}
            <div class="col-lg-4 col-md-6" data-card-id="{{ card.id }}">
                <div class="profile-card">
                    <div class="card-header-section">
                        <h5 class="card-title">{{ card.title }}</h5>
                    </div>
                    <div class="card-body-section">
                        <div class="card-links">
                            {# Loop aninhado para criar os links dinamicamente #}
                            {% for link in card.links %}
                                <a href="{% url link.url %}" class="card-link">{{ link.text }}</a>
                            {% endfor %}
                        </div>
                        <div class="card-icon-wrapper">
                            <img src="{% static card.icon %}" class="card-icon" alt="Ícone de {{ card.title }}">
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

    </div> 
</div>

{% endblock %}

{% block extra_js %}
{# O seu JavaScript para reordenar os cards continua funcionando perfeitamente! #}
{# Ele não precisa de nenhuma alteração, pois ele se baseia no 'data-card-id' que estamos preservando. #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('card-container');
    const storageKey = 'profileCardOrder';

    function restoreOrder() {
        const savedOrderJSON = localStorage.getItem(storageKey);
        if (savedOrderJSON) {
            const savedOrder = JSON.parse(savedOrderJSON);
            savedOrder.forEach(cardId => {
                const cardElement = container.querySelector(`[data-card-id="${cardId}"]`);
                if (cardElement) {
                    container.appendChild(cardElement);
                }
            });
        }
    }

    function saveOrder(sortableInstance) {
        const currentOrder = sortableInstance.toArray();
        localStorage.setItem(storageKey, JSON.stringify(currentOrder));
    }

    restoreOrder();

    const sortable = new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        dataIdAttr: 'data-card-id',
        onEnd: function() {
            saveOrder(this);
        },
    });
});
</script>
{% endblock %}
