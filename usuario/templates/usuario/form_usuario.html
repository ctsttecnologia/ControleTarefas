
{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
    {% if form.instance.pk %}Editar Usuário{% else %}Cadastrar Novo Usuário{% endif %}
{% endblock %}

{% block extra_head %}
    {{ form.media.css }}
    <style>
        /* ==========================================================================
           ESTILOS PARA O WIDGET FilteredSelectMultiple (LADO A LADO RESPONSIVO)
           ========================================================================== */

        /* --- 1. O Contêiner Principal (Flexbox) --- */
        .selector {
            display: flex;
            flex-wrap: wrap;         /* ESSENCIAL: Permite que os itens quebrem a linha em telas pequenas */
            align-items: stretch;    /* Faz com que os cards e as setas tenham a mesma altura */
            gap: 1rem;               /* Espaçamento entre os cards e as setas */
        }

        /* --- 2. Os Cards de Seleção ("Disponíveis" e "Escolhidos") --- */
        .selector .selector-available,
        .selector .selector-chosen {
            flex: 1;                 /* FAZ OS CARDS CRESCEREM PARA OCUPAR O ESPAÇO IGUALMENTE */
            min-width: 280px;        /* LARGURA MÍNIMA: Se a tela for menor que ~580px, os cards vão se empilhar */
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem; /* Borda arredondada do Bootstrap */
            background-color: #fff;
            overflow: hidden;        /* Garante que o conteúdo não vaze das bordas arredondadas */
        }

        /* --- 3. A Coluna de Controles (Setas) --- */
        .selector .selector-control {
            display: flex;
            flex-direction: column;
            justify-content: center; /* Centraliza as setas verticalmente */
            align-items: center;
            gap: 0.5rem;
            flex-basis: 40px;        /* Define uma largura base para a coluna de setas */
        }

        /* --- 4. Estilização Interna dos Cards (Títulos, Filtro, Lista) --- */

        /* Títulos (h2) */
        .selector h2 {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            margin: 0;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* Campo de Filtro */
        .selector .selector-filter {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        .selector .selector-filter input {
            width: 100% !important;
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        /* A lista de opções */
        .selector select {
            flex-grow: 1; /* Faz a lista crescer para preencher o espaço vertical */
            border: none;
            padding: 0.5rem;
            min-height: 250px; /* Altura mínima para os cards */
        }
        .selector select option {
            padding: 0.3rem 0.6rem;
            border-radius: 0.2rem;
            cursor: pointer;
        }
        .selector select option:hover {
            background-color: #e9ecef;
        }

        /* --- 5. Estilização das Setas (para parecerem botões) --- */
        .selector .selector-control a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border: 1px solid #adb5bd;
            color: #495057;
            background-color: #fff;
            border-radius: 0.375rem;
            text-decoration: none;
            transition: all 0.15s ease-in-out;
        }
        .selector .selector-control a:hover {
            background-color: #0d6efd; /* Azul primário do Bootstrap */
            border-color: #0d6efd;
            color: #fff;
        }

        /* --- BÔNUS: Substitui o texto das setas por ícones (Unicode) para um visual mais limpo --- */
        .selector .selector-add::before { content: "›"; }
        .selector .selector-remove::before { content: "‹"; }
        .selector .selector-addall::before { content: "»"; }
        .selector .selector-clearall::before { content: "«"; }
        
        .selector .selector-control a {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1;
            color: transparent; /* Esconde o texto original (ex: "Choose") */
            position: relative;
        }
        .selector .selector-control a::before {
            color: #495057; /* Cor do ícone */
            position: absolute;
            transition: color 0.15s ease-in-out;
        }
        .selector .selector-control a:hover::before {
            color: #fff;
        }
    </style>
{% endblock %}

{% block content %}
    {% include 'usuario/includes/submenu.html' %}

    <div class="container form-container">
        <div class="card shadow-sm rounded-lg">
            <div class="card-header bg-primary text-white py-3">
                <h2 class="h4 mb-0">
                    {% if form.instance.pk %}Editar Usuário: {{ form.instance.username }}{% else %}Cadastrar Novo Usuário{% endif %}
                </h2>
            </div>
            <div class="card-body p-4 p-md-5">
                <form method="post" novalidate>
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}
                    
                    <h5 class="mb-3">Informações de Login</h5>
                    <div class="row g-3">
                        {% include 'usuario/includes/form_field.html' with field=form.username %}
                        {% include 'usuario/includes/form_field.html' with field=form.email %}
                        {% include 'usuario/includes/form_field.html' with field=form.first_name %}
                        {% include 'usuario/includes/form_field.html' with field=form.last_name %}

                        {# Campos de senha e vínculo - Apenas na criação #}
                        {% if not form.instance.pk %}
                            {% include 'usuario/includes/form_field.html' with field=form.password1 %}
                            {% include 'usuario/includes/form_field.html' with field=form.password2 %}
                            {% include 'usuario/includes/form_field.html' with field=form.funcionario col_size=12 %}
                        {% endif %}
                    </div>

                    {% if form.instance.pk %}
                        <hr class="my-4">
                        <h5 class="mb-3">Permissões e Filiais</h5>
                        <div class="row g-4">
                            <div class="col-12 mb-3">
                                <label for="{{ form.filiais_permitidas.id_for_label }}" class="form-label">Filiais Permitidas</label>
                                {{ form.filiais_permitidas }}
                                {% if form.filiais_permitidas.help_text %}<div class="form-text">{{ form.filiais_permitidas.help_text }}</div>{% endif %}
                            </div>
                            <div class="col-12 mb-3">
                                <label for="{{ form.groups.id_for_label }}" class="form-label">Grupos</label>
                                {{ form.groups }}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h5 class="mb-3">Status e Acesso</h5>
                        <div class="d-flex flex-column gap-2">
                            <div class="form-check">
                                {% render_field form.is_active class="form-check-input" %}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Usuário ativo?</label>
                            </div>
                            <div class="form-check">
                                {% render_field form.is_staff class="form-check-input" %}
                                <label class="form-check-label" for="{{ form.is_staff.id_for_label }}">Acesso ao painel administrativo?</label>
                            </div>
                            <div class="form-check">
                                {% render_field form.is_superuser class="form-check-input" %}
                                <label class="form-check-label" for="{{ form.is_superuser.id_for_label }}">Status de Superusuário?</label>
                            </div>
                        </div>
                    {% endif %}
                    
                    <hr class="mt-4">
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{% url 'usuario:lista_usuarios' %}" class="btn btn-secondary px-4">Cancelar</a>
                        <button type="submit" class="btn btn-primary px-4">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% url 'admin:jsi18n' %}"></script>
    {{ form.media.js }}
{% endblock %}
