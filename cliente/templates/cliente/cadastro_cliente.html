
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<style>
    /* Estilos específicos para este template */
    .form-floating > label {
        transform-origin: 0 0;
        transition: all 0.2s ease-out;
    }
    
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label,
    .form-floating > .form-select ~ label {
        transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
        opacity: 0.8;
    }
    
    .select2-container--default .select2-selection--single {
        height: calc(3.5rem + 2px);
        padding: 1rem 0.75rem;
        border: 1px solid #ced4da;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: calc(3.5rem + 2px);
    }
    
    .card {
        border-radius: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 0.375rem;
    }
        /* Estilos para as máscaras e validação */
    .invalid-input {
        border-color: #dc3545 !important;
    }
    
    .valid-input {
        border-color: #28a745 !important;
    }
    
    .mask-error {
        color: #dc3545;
        font-size: 0.875em;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Mensagens de erro/sucesso -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-user-plus me-2"></i>Cadastrar Cliente</h2>

        <a href="{% url 'cliente:lista_clientes' %}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i> Clientes Cadastrados
        </a>
    </div>
    
    <!-- Formulário -->
    <div class="card shadow">
        <div class="card-body">
            <form method="post" id="clienteForm" novalidate>
                {% csrf_token %}
                
                <!-- Erros não relacionados a campos específicos -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="row g-3">
                    <!-- Coluna 1 -->
                    <div class="col-md-6">
                        <!-- Nome -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="{{ form.nome.id_for_label }}" 
                                   name="{{ form.nome.name }}" placeholder="{{ form.nome.label }}"
                                   value="{{ form.nome.value|default_if_none:'' }}" required>
                            <label for="{{ form.nome.id_for_label }}">{{ form.nome.label }}</label>
                            {% if form.nome.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.nome.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Endereço -->
                        <div class="mb-3">
                            <label for="{{ form.logradouro.id_for_label }}" class="form-label">
                                {{ form.logradouro.label }} <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2" id="{{ form.logradouro.id_for_label }}" 
                                    name="{{ form.logradouro.name }}" required>
                                {% for choice in form.logradouro.field.choices %}
                                    <option value="{{ choice.0 }}" {% if form.logradouro.value == choice.0 %}selected{% endif %}>
                                        {{ choice.1 }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                <a href="{% url 'logradouro:cadastrar_logradouro' %}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-plus me-1"></i> Novo Endereço
                                </a>
                            </div>
                            {% if form.logradouro.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.logradouro.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Contrato -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="{{ form.contrato.id_for_label }}" 
                                   name="{{ form.contrato.name }}" placeholder="{{ form.contrato.label }}"
                                   value="{{ form.contrato.value|default_if_none:'' }}">
                            <label for="{{ form.contrato.id_for_label }}">{{ form.contrato.label }}</label>
                            {% if form.contrato.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.contrato.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Coluna 2 -->
                    <div class="col-md-6">
                        <!-- Razão Social -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="{{ form.razao_social.id_for_label }}" 
                                   name="{{ form.razao_social.name }}" placeholder="{{ form.razao_social.label }}"
                                   value="{{ form.razao_social.value|default_if_none:'' }}">
                            <label for="{{ form.razao_social.id_for_label }}">{{ form.razao_social.label }}</label>
                            {% if form.razao_social.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.razao_social.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- CNPJ -->
                        <div class="mb-3">
                            <label for="id_cnpj" class="form-label">
                                CNPJ <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                <input type="text" class="form-control" id="id_cnpj" 
                                    name="cnpj" placeholder="00.000.000/0000-00"
                                    value="{{ form.cnpj.value|default_if_none:'' }}" required>
                            </div>
                            <small class="text-muted">Formato: 00.000.000/0000-00</small>
                            <div class="mask-error" id="cnpj-error">CNPJ incompleto ou inválido</div>
                            {% if form.cnpj.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cnpj.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Coluna 3 -->
                    <div class="col-md-6">
                        <!-- Telefone -->
                    <div class="mb-3">
                        <label for="id_telefone" class="form-label">
                            Telefone
                        </label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            <input type="text" class="form-control" id="id_telefone" 
                                name="telefone" placeholder="(00) 00000-0000"
                                value="{{ form.telefone.value|default_if_none:'' }}">
                        </div>
                        <small class="text-muted">Formato: (00) 00000-0000</small>
                        <div class="mask-error" id="telefone-error">Telefone incompleto ou inválido</div>
                        {% if form.telefone.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.telefone.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Coluna 4 -->
                    <div class="col-md-6">
                        <!-- Data de Início -->
                        <div class="mb-3">
                            <label for="{{ form.data_de_inicio.id_for_label }}" class="form-label">
                                {{ form.data_de_inicio.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date" class="form-control" id="{{ form.data_de_inicio.id_for_label }}" 
                                       name="{{ form.data_de_inicio.name }}" 
                                       value="{{ form.data_de_inicio.value|date:'Y-m-d' }}" required>
                            </div>
                            {% if form.data_de_inicio.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.data_de_inicio.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Status -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="{{ form.estatus.id_for_label }}" 
                                   name="{{ form.estatus.name }}" {% if form.estatus.value %}checked{% endif %}>
                            <label class="form-check-label" for="{{ form.estatus.id_for_label }}">
                                {{ form.estatus.label }}
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Botões de ação -->
                <div class="d-flex justify-content-between mt-4 border-top pt-3">
                    <a href="{% url 'cliente:lista_clientes' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
$(document).ready(function() {
    // Configuração das máscaras com validação
    $('#id_cnpj').mask('00.000.000/0000-00', {
        onComplete: function(cep) {
            validateCnpj();
        },
        onChange: function(cep) {
            validateCnpj();
        }
    });
    
    $('#id_telefone').mask('(00) 00000-0000', {
        onComplete: function(tel) {
            validateTelefone();
        },
        onChange: function(tel) {
            validateTelefone();
        }
    });
    
    // Funções de validação
    function validateCnpj() {
        var cnpj = $('#id_cnpj').cleanVal();
        var cnpjError = $('#cnpj-error');
        
        if (cnpj.length === 14) {
            $('#id_cnpj').removeClass('invalid-input').addClass('valid-input');
            cnpjError.hide();
            return true;
        } else {
            $('#id_cnpj').removeClass('valid-input').addClass('invalid-input');
            if (cnpj.length > 0) {
                cnpjError.show();
            } else {
                cnpjError.hide();
            }
            return false;
        }
    }
    
    function validateTelefone() {
        var tel = $('#id_telefone').cleanVal();
        var telError = $('#telefone-error');
        
        // Telefone é opcional, mas se preenchido deve estar completo
        if (tel.length === 0 || tel.length === 11) {
            $('#id_telefone').removeClass('invalid-input').addClass('valid-input');
            telError.hide();
            return true;
        } else {
            $('#id_telefone').removeClass('valid-input').addClass('invalid-input');
            if (tel.length > 0) {
                telError.show();
            } else {
                telError.hide();
            }
            return false;
        }
    }
    
    // Validação do formulário
    $('#clienteForm').on('submit', function(e) {
        var isValid = true;
        
        // Valida CNPJ
        if (!validateCnpj()) {
            isValid = false;
            $('#cnpj-error').show();
        }
        
        // Valida Telefone (opcional)
        if ($('#id_telefone').val().length > 0 && !validateTelefone()) {
            isValid = false;
            $('#telefone-error').show();
        }
        
        if (!isValid) {
            e.preventDefault();
            // Rolagem para o primeiro erro
            $('html, body').animate({
                scrollTop: $('.invalid-input').first().offset().top - 100
            }, 500);
        }
    });
    
    // Validação inicial ao carregar a página
    validateCnpj();
    validateTelefone();
});
</script>
{% endblock %}
