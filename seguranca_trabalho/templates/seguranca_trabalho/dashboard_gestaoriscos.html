
{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard de Segurança{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'cssseguranca/dashboard_sst.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header mb-4">
        <div>
            <h1 class="h2 fw-bold">Dashboard de Segurança</h1>
            <p class="text-muted mb-0">Visão geral dos indicadores de segurança do trabalho.</p>       
        </div>
        <div class="action-buttons">          
            <a href="{% url 'seguranca_trabalho:equipamento_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i> Novo Equipamento
            </a>
            <a href="{% url 'seguranca_trabalho:ficha_criar_form' %}" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-text me-1"></i> Nova Ficha EPI
            </a>
            <a href="{% url 'seguranca_trabalho:fornecedor_create' %}" class="btn btn-outline-primary">
                <i class="bi bi-plus-lg me-1"></i> Nova Fornecedor
            </a>
            <a href="{% url 'seguranca_trabalho:fabricante_create' %}" class="btn btn-outline-primary">
                <i class="bi bi-plus-lg me-1"></i> Nova Fabricante
            </a>
        </div>
    </div>
    <a class="dropdown-item" href="{% url 'gestao_riscos:agendar_inspecao' %}">
        <i class="bi bi-calendar-plus me-2"></i>Agendar Inspeção
    </a>     
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card">
                <div class="icon-circle icon-primary"><i class="bi bi-hdd-stack-fill"></i></div>
                <div class="ms-3">
                    <p class="text-muted mb-1">Equipamentos Ativos</p>
                    <h3 class="fw-bold mb-0">{{ total_equipamentos|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card">
                <div class="icon-circle icon-warning"><i class="bi bi-journal-check"></i></div>
                <div class="ms-3">
                    <p class="text-muted mb-1">Inspeções Pendentes</p>
                    <h3 class="fw-bold mb-0">{{ inspecoes_pendentes|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card">
                <div class="icon-circle icon-danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
                <div class="ms-3">
                    <p class="text-muted mb-1">Incidentes no Mês</p>
                    <h3 class="fw-bold mb-0">{{ incidentes_mes|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card">
                <div class="icon-circle icon-info"><i class="bi bi-shield-shaded"></i></div>
                <div class="ms-3">
                    <p class="text-muted mb-1">EPIs Próx. Venc.</p>
                    <h3 class="fw-bold mb-0">{{ epis_prox_vencimento|default:"0" }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header"><h5 class="card-title fw-bold mb-0">Análise de Pareto de Causas de Incidentes</h5></div>
                <div class="card-body chart-container"><canvas id="paretoChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header"><h5 class="card-title fw-bold mb-0">Incidentes por Setor</h5></div>
                <div class="card-body chart-container"><canvas id="incidentesChart"></canvas></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ dados_grafico_status_json|json_script:"dadosStatus" }}
{{ dados_grafico_incidentes_json|json_script:"dadosIncidentes" }}
{{ dados_pareto_json|json_script:"dadosPareto" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const getThemeColors = () => {
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        return {
            textColor: isDarkMode ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.7)',
            gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
            tooltipBg: isDarkMode ? '#343a40' : '#fff',
            tooltipColor: isDarkMode ? '#fff' : '#000'
        };
    };
    
    let charts = {}; // Objeto para guardar as instâncias dos gráficos

    const createCharts = () => {
        const themeColors = getThemeColors();
        
        // Destrói gráficos antigos antes de recriar
        Object.values(charts).forEach(chart => chart.destroy());

        // --- DADOS ---
        const incidentesData = JSON.parse(document.getElementById('dadosIncidentes').textContent);
        const paretoData = JSON.parse(document.getElementById('dadosPareto').textContent);

        // --- GRÁFICO DE INCIDENTES POR SETOR (BARRA HORIZONTAL) ---
        const incidentesCtx = document.getElementById('incidentesChart')?.getContext('2d');
        if (incidentesCtx) {
            charts.incidentes = new Chart(incidentesCtx, {
                type: 'bar',
                data: {
                    labels: incidentesData.labels,
                    datasets: [{
                        label: 'Nº de Incidentes',
                        data: incidentesData.data,
                        backgroundColor: 'rgba(var(--bs-primary-rgb), 0.7)',
                    }]
                },
                options: { 
                    indexAxis: 'y', // <-- Gráfico deitado
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, title: { display: false } }, 
                    scales: { 
                        x: { ticks: { color: themeColors.textColor }, grid: { color: themeColors.gridColor } },
                        y: { ticks: { color: themeColors.textColor }, grid: { color: 'transparent' } }
                    } 
                }
            });
        }

        // --- GRÁFICO DE PARETO (BARRA + LINHA) ---
        const paretoCtx = document.getElementById('paretoChart')?.getContext('2d');
        if (paretoCtx) {
            charts.pareto = new Chart(paretoCtx, {
                type: 'bar',
                data: {
                    labels: paretoData.labels,
                    datasets: [
                        {
                            label: 'Nº de Incidentes',
                            data: paretoData.data_barras,
                            backgroundColor: 'rgba(var(--bs-primary-rgb), 0.7)',
                            yAxisID: 'y',
                        },
                        {
                            type: 'line',
                            label: '% Acumulado',
                            data: paretoData.data_linha,
                            borderColor: 'rgba(var(--bs-danger-rgb), 1)',
                            backgroundColor: 'rgba(var(--bs-danger-rgb), 0.2)',
                            yAxisID: 'y1',
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: themeColors.textColor }, grid: { color: themeColors.gridColor } },
                        y: {
                            type: 'linear', position: 'left', beginAtZero: true,
                            title: { display: true, text: 'Quantidade de Incidentes', color: themeColors.textColor },
                            ticks: { color: themeColors.textColor }, grid: { color: 'transparent' }
                        },
                        y1: {
                            type: 'linear', position: 'right', min: 0, max: 100,
                            title: { display: true, text: 'Percentual Acumulado', color: themeColors.textColor },
                            ticks: { color: themeColors.textColor, callback: (value) => value + "%" },
                            grid: { drawOnChartArea: false },
                        }
                    },
                    plugins: { legend: { labels: { color: themeColors.textColor } } }
                }
            });
        }
    };

    // Renderização inicial
    createCharts();

    // Sincronização com o tema global
    const themeObserver = new MutationObserver(createCharts);
    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
});
</script>
{% endblock %}