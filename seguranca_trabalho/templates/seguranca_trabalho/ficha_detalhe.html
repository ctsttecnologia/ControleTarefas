

{% extends "seguranca_trabalho/_base_sst.html" %}
{% load widget_tweaks %}

{% block title %}Ficha de EPI: {{ ficha.funcionario.nome_completo }}{% endblock %}

{% block sst_content %}
<div class="card shadow-sm mb-4">
    <div class="card-header ficha-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-0">{{ ficha.funcionario.nome_completo }}</h1>
                <p class="text-muted mb-0">Cargo: {{ ficha.funcionario.cargo.nome }} | Matrícula: {{ ficha.funcionario.matricula }}</p>
            </div>
            <a href="{% url 'seguranca_trabalho:ficha_lista' %}" class="btn btn-outline-secondary">Voltar</a>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Entregas de EPI</h5>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaEntregaModal">
            <i class="bi bi-plus-lg me-1"></i> Adicionar Entrega
        </button>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Equipamento</th><th>Qtd.</th><th>Data Entrega</th><th>Status</th><th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for entrega in ficha.entregas.all %}
                <tr>
                    <td>{{ entrega.equipamento }}</td>
                    <td>{{ entrega.quantidade }}</td>
                    <td>{{ entrega.data_entrega|date:"d/m/Y H:i" }}</td>
                    <td>{{ entrega.status }}</td>
                    <td>
                        {% if not entrega.assinatura_recebimento %}
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#assinarModal" data-entrega-id="{{ entrega.pk }}">Assinar Recebimento</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center py-3">Nenhuma entrega registrada para esta ficha.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="novaEntregaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Registrar Nova Entrega</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form action="{% url 'seguranca_trabalho:adicionar_entrega' ficha.pk %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Equipamento</label>
                        {% render_field entrega_form.equipamento class="form-select" %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        {% render_field entrega_form.quantidade class="form-control" %}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Registrar e Pedir Assinatura</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="assinarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Confirmar Recebimento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p>Eu, {{ ficha.funcionario.nome_completo }}, confirmo o recebimento do(s) EPI(s) listado(s).</p>
                <form id="assinaturaForm" method="post">
                    {% csrf_token %}
                    {% render_field assinatura_form.assinatura_base64 %}
                    <div class="text-center">
                        <canvas id="signature-pad" class="signature-pad" width=400 height=200></canvas>
                        <div>
                            <button type="button" id="clear-signature" class="btn btn-sm btn-secondary mt-2">Limpar</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100 mt-3">Salvar Assinatura</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block sst_extra_js %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const assinarModalEl = document.getElementById('assinarModal');
    if (assinarModalEl) {
        const signaturePad = new SignaturePad(document.getElementById('signature-pad'));
        const form = document.getElementById('assinaturaForm');
        
        document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());

        assinarModalEl.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const entregaId = button.getAttribute('data-entrega-id');
            const url = `{% url 'seguranca_trabalho:assinar_entrega' 0 %}`.replace('0', entregaId);
            form.action = url;
        });

        form.addEventListener('submit', function(e) {
            if (signaturePad.isEmpty()) {
                alert("Por favor, forneça sua assinatura.");
                e.preventDefault();
            } else {
                const dataURL = signaturePad.toDataURL();
                form.querySelector('input[name="assinatura_base64"]').value = dataURL;
            }
        });
    }
});
</script>
{% endblock %}
