
{% load widget_tweaks %}

{% load static %}

{% block content %}

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{% static 'csstemplate/styles.css' %}">
    <link rel="stylesheet" href="{% static 'cssdp/stylesfuncionario.css' %}">

<!-- Barra de Navegação Principal -->
{% include 'includes/header.html' %}


<div class="header-container">
    <h2 class="page-title" align="center">Editar Funcionário</h2>
</div>
<div class="container">
    <!-- Painel de Navegação -->
    <div class="navigation-panel">
        <a href="{% url 'departamento_pessoal:departamento_pessoal' %}" class="btn-navigation">
            <i class="fas fa-users"></i> Departamento Pessoal
        </a>
    </div>

    <!-- Formulário Principal -->
    <div class="form-container">
        <form method="post" id="funcionarioForm" class="employee-form" novalidate>
            {% csrf_token %}
            
            <!-- Seção 1: Dados Pessoais -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i> Dados Pessoais
                </h3>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="{{ form.nome.id_for_label }}" class="form-label">Nome Completo *</label>
                        {{ form.nome|add_class:"form-control" }}
                        {% if form.nome.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.nome.errors.as_text }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label for="{{ form.data_nascimento.id_for_label }}" class="form-label">Data Nascimento *</label>
                        {{ form.data_nascimento|add_class:"form-control"|attr:"type:date" }}
                        {% if form.data_nascimento.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.data_nascimento.errors.as_text }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="{{ form.naturalidade.id_for_label }}" class="form-label">Naturalidade</label>
                        {{ form.naturalidade|add_class:"form-control" }}
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label for="{{ form.sexo.id_for_label }}" class="form-label">Sexo *</label>
                        {{ form.sexo|add_class:"form-control" }}
                    </div>
                </div>
            </div>
            
            <!-- Seção 2: Contato -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-address-book"></i> Contato
                </h3>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="{{ form.telefone.id_for_label }}" class="form-label">Telefone *</label>
                        {{ form.telefone|add_class:"form-control telefone-mask"|attr:"placeholder:(00) 00000-0000" }}
                        {% if form.telefone.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.telefone.errors.as_text }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!--<div class="form-group col-md-6">
                        <label for="{{ form.email.id_for_label }}" class="form-label">E-mail *</label>
                        {{ form.email|add_class:"form-control" }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.email.errors.as_text }}
                            </div>
                        {% endif %}
                    </div>-->
                </div>
            </div>
            
            <!-- Seção 3: Status -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-info-circle"></i> Status
                </h3>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="{{ form.estatus.id_for_label }}" class="form-label">Situação *</label>
                        {{ form.estatus|add_class:"form-control" }}
                    </div>
                </div>
            </div>
            
            <!-- Botões de Ação -->
            <div class="form-actions">
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Salvar e Continuar
                </button>
                <a href="{% url 'departamento_pessoal:lista_funcionarios' %}" class="btn-cancel">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
            
        </form>
    </div>
</div>
{% endblock %}
<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
$(document).ready(function() {
    // Máscaras
    $('.telefone-mask').mask('(00) 00000-0000');
    
    // Armazena os valores originais dos campos
    const originalValues = {};
    $('input, select').each(function() {
        originalValues[this.name] = $(this).val();
    });

    // Função para verificar se email já existe
    function emailExists(email, callback) {
        if (!email || email === originalValues['email']) {
            callback(false);
            return;
        }
        
        $.get('/check_email_exists/', {email: email}, function(data) {
            callback(data.exists);
        }).fail(function() {
            // Em caso de erro, assume que não existe para não bloquear o usuário
            callback(false);
        });
    }

    // Validação do formulário
    $('#funcionarioForm').submit(function(e) {
        e.preventDefault();
        let isValid = true;
        let hasChanges = false;
        const changedFields = [];
        const emailField = $('input[name="email"]');
        const currentEmail = emailField.val();
        
        // Verifica campos obrigatórios vazios
        $('[required]').each(function() {
            if ($(this).val() === '') {
                $(this).addClass('is-invalid');
                isValid = false;
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            $('html, body').animate({
                scrollTop: $('.is-invalid').first().offset().top - 100
            }, 500);
            return;
        }
        
        // Verifica alterações nos campos
        $('input, select').each(function() {
            const currentValue = $(this).val();
            if (originalValues[this.name] !== undefined && currentValue !== originalValues[this.name]) {
                changedFields.push({
                    name: this.name,
                    label: $('label[for="' + $(this).attr('id') + '"]').text().replace(' *', ''),
                    oldValue: originalValues[this.name],
                    newValue: currentValue
                });
            }
        });
        
        // Verificação especial para e-mail
        if (emailField.length > 0 && changedFields.some(f => f.name === 'email')) {
            emailExists(currentEmail, function(exists) {
                if (exists) {
                    // Se e-mail já existe, mantém o original sem pedir confirmação
                    emailField.val(originalValues['email']);
                    changedFields = changedFields.filter(f => f.name !== 'email');
                    
                    if (changedFields.length > 0) {
                        showConfirmationDialog(changedFields);
                    } else {
                        $('#funcionarioForm').unbind('submit').submit();
                    }
                } else {
                    if (changedFields.length > 0) {
                        showConfirmationDialog(changedFields);
                    } else {
                        $('#funcionarioForm').unbind('submit').submit();
                    }
                }
            });
        } else {
            if (changedFields.length > 0) {
                showConfirmationDialog(changedFields);
            } else {
                $('#funcionarioForm').unbind('submit').submit();
            }
        }
    });

    function showConfirmationDialog(fields) {
        let message = 'Você está alterando os seguintes campos:\n\n';
        fields.forEach(field => {
            message += `• ${field.label}: De "${field.oldValue}" para "${field.newValue}"\n`;
        });
        
        message += '\nDeseja realmente fazer essas alterações?';
        
        if (confirm(message)) {
            $('#funcionarioForm').unbind('submit').submit();
        } else {
            // Restaura valores originais se o usuário cancelar
            fields.forEach(field => {
                $('[name="' + field.name + '"]').val(field.oldValue);
            });
        }
    }

    // Destaque visual para campos alterados (opcional)
    $('input, select').on('input change', function() {
        if (originalValues[this.name] !== undefined && $(this).val() !== originalValues[this.name]) {
            $(this).addClass('changed');
            if (!$(this).next('.changed-field-marker').length) {
                $(this).after('<span class="changed-field-marker">(alterado)</span>');
            }
        } else {
            $(this).removeClass('changed');
            $(this).next('.changed-field-marker').remove();
        }
    });
});
</script>
<!-- Rodapé -->
{% include 'includes/footer.html' %}   