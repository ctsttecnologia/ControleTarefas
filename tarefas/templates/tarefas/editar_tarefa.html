

{% load static %}

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editar Tarefa - {{ tarefa.titulo }}</title>
<link rel="stylesheet" href="{% static 'csstarefa/editstyles.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Barra de Navegação Principal -->    
{% include 'includes/header.html' %}
{% block content %}  


{% comment %} Debug dos valores do formulário {% endcomment %}
<div style="display: none;">
    <p>Data Início: {{ form.data_inicio.value }}</p>
    <p>Prazo: {{ form.prazo.value }}</p>
    <p>Status: {{ form.status.value }}</p>
    <p>Prioridade: {{ form.prioridade.value }}</p>
</div>
    <div class="container">
        <header class="form-header">
            <h1 class="form-title">
                <i class="fas fa-edit"></i> Editar Tarefa
                <span class="badge status-{{ tarefa.status }}">{{ tarefa.get_status_display }}</span>
            </h1>
            <div class="action-buttons">
                <a href="{% url 'tarefas:listar_tarefas' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <a href="{% url 'tarefas:tarefa_detail' tarefa.pk %}" class="btn btn-info">
                    <i class="fas fa-eye"></i> Detalhes
                </a>
            </div>
        </header>

        <main class="form-container">
            <form method="post" action="{% url 'tarefas:editar_tarefa' tarefa.pk %}" class="task-form" enctype="multipart/form-data" id="tarefaForm">
                {% csrf_token %}
                <!-- Mensagens de sistema -->
                {% if messages %}
                <div class="alert-container">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Erros gerais do formulário -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <div class="form-grid">
                    <!-- Seção: Informações Básicas -->
                    <div class="form-section card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i> Informações Básicas
                        </div>
                        <div class="card-body">
                            <div class="form-group {% if form.titulo.errors %}has-error{% endif %}">
                                <label for="{{ form.titulo.id_for_label }}" class="form-label required">
                                    <i class="fas fa-heading"></i> Título
                                </label>
                                {{ form.titulo }}
                                {% if form.titulo.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.titulo.errors }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group {% if form.descricao.errors %}has-error{% endif %}">
                                <label for="{{ form.descricao.id_for_label }}" class="form-label">
                                    <i class="fas fa-align-left"></i> Descrição
                                </label>
                                {{ form.descricao }}
                                {% if form.descricao.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.descricao.errors }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group {% if form.projeto.errors %}has-error{% endif %}">
                                <label for="{{ form.projeto.id_for_label }}" class="form-label">
                                    <i class="fas fa-project-diagram"></i> Projeto
                                </label>
                                {{ form.projeto }}
                                {% if form.projeto.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.projeto.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Status e Prioridade -->
                    <div class="form-section card">
                        <div class="card-header">
                            <i class="fas fa-tasks"></i> Status e Prioridade
                        </div>
                        <div class="card-body">
                            <div class="form-group {% if form.status.errors %}has-error{% endif %}">
                                <label for="{{ form.status.id_for_label }}" class="form-label required">
                                    <i class="fas fa-flag"></i> Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.status.errors }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group {% if form.prioridade.errors %}has-error{% endif %}">
                                <label for="{{ form.prioridade.id_for_label }}" class="form-label required">
                                    <i class="fas fa-exclamation-triangle"></i> Prioridade
                                </label>
                                {{ form.prioridade }}
                                {% if form.prioridade.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.prioridade.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Datas e Prazos -->
                    <div class="form-section card">
                        <div class="card-header">
                            <i class="far fa-calendar-alt"></i> Datas e Prazos
                        </div>
                        <div class="card-body">
                            <div class="form-group {% if form.data_inicio.errors %}has-error{% endif %}">
                                <label for="{{ form.data_inicio.id_for_label }}" class="form-label required">
                                    <i class="far fa-clock"></i> Data de Início
                                </label>
                                <div class="input-group">
                                    <input type="datetime-local" 
                                            id="{{ form.prazo.id_for_label }}" 
                                            name="{{ form.prazo.name }}" 
                                            value="{{ form.prazo.value|date:'Y-m-d\TH:i'|default:'' }}"
                                            class="form-control datetime-input">
                                    
                                    <div class="input-group-append">
                                        <span class="input-group-text"><i class="far fa-calendar"></i></span>
                                    </div>
                                </div>
                                {% if form.data_inicio.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.data_inicio.errors }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group {% if form.prazo.errors %}has-error{% endif %}">
                                <label for="{{ form.prazo.id_for_label }}" class="form-label">
                                    <i class="fas fa-hourglass-end"></i> Prazo Final
                                </label>
                                <div class="input-group">
                                    <input type="datetime-local" 
                                           id="{{ form.prazo.id_for_label }}" 
                                           name="{{ form.prazo.name }}" 
                                           value="{{ form.prazo.value|date:'Y-m-d\TH:i'|default:'' }}"
                                           class="form-control datetime-input">
                                    <div class="input-group-append">
                                        <span class="input-group-text"><i class="far fa-calendar"></i></span>
                                    </div>
                                </div>
                                {% if form.prazo.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.prazo.errors }}
                                </div>
                                {% endif %}
                            </div>

                            {% if tarefa.concluida_em %}
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-check-circle"></i> Concluída em
                                </label>
                                <input type="text" 
                                       value="{{ tarefa.concluida_em|date:'d/m/Y H:i' }}" 
                                       class="form-control" 
                                       disabled>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Seção: Responsáveis -->
                    <div class="form-section card">
                        <div class="card-header">
                            <i class="fas fa-users"></i> Responsáveis
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-user-plus"></i> Criado por
                                </label>
                                <input type="text" 
                                       value="{{ tarefa.usuario.get_full_name|default:tarefa.usuario.username }}" 
                                       class="form-control" 
                                       disabled>
                            </div>

                            <div class="form-group {% if form.responsavel.errors %}has-error{% endif %}">
                                <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                                    <i class="fas fa-user-tie"></i> Responsável
                                </label>
                                {{ form.responsavel }}
                                {% if form.responsavel.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.responsavel.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Tempo -->
                    <div class="form-section card">
                        <div class="card-header">
                            <i class="fas fa-stopwatch"></i> Tempo
                        </div>
                        <div class="card-body">
                            <div class="form-group {% if form.duracao_prevista.errors %}has-error{% endif %}">
                                <label for="{{ form.duracao_prevista.id_for_label }}" class="form-label">
                                    <i class="far fa-clock"></i> Duração Prevista
                                </label>
                                <div class="input-group">
                                    {{ form.duracao_prevista }}
                                    <div class="input-group-append">
                                        <span class="input-group-text">horas</span>
                                    </div>
                                </div>
                                {% if form.duracao_prevista.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.duracao_prevista.errors }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group {% if form.tempo_gasto.errors %}has-error{% endif %}">
                                <label for="{{ form.tempo_gasto.id_for_label }}" class="form-label">
                                    <i class="fas fa-clock"></i> Tempo Gasto
                                </label>
                                <div class="input-group">
                                    {{ form.tempo_gasto }}
                                    <div class="input-group-append">
                                        <span class="input-group-text">horas</span>
                                    </div>
                                </div>
                                {% if form.tempo_gasto.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i> {{ form.tempo_gasto.errors }}
                                </div>
                                {% endif %}
                            </div>

                            {% if tarefa.duracao_prevista and tarefa.tempo_gasto %}
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-chart-line"></i> Progresso
                                </label>
                                <div class="progress-container">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped 
                                                    {% if tarefa.progresso < 50 %}bg-danger
                                                    {% elif tarefa.progresso < 75 %}bg-warning
                                                    {% else %}bg-success{% endif %}" 
                                             style="width: {{ tarefa.progresso }}%">
                                            <span class="progress-text">{{ tarefa.progresso }}%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        {{ tarefa.tempo_gasto }}h de {{ tarefa.duracao_prevista }}h
                                    </small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Seção: Informações do Sistema -->
                    <div class="form-section card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i> Informações do Sistema
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="far fa-calendar-plus"></i> Criado em
                                </label>
                                <input type="text" 
                                       value="{{ tarefa.data_criacao|date:'d/m/Y H:i' }}" 
                                       class="form-control" 
                                       disabled>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sync-alt"></i> Última Atualização
                                </label>
                                <input type="text" 
                                       value="{{ tarefa.data_atualizacao|date:'d/m/Y H:i' }}" 
                                       class="form-control" 
                                       disabled>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-traffic-light"></i> Situação
                                </label>
                                <div class="status-indicator {% if tarefa.atrasada %}status-atrasada{% else %}status-ok{% endif %}">
                                    <i class="fas fa-{% if tarefa.atrasada %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                                    {% if tarefa.atrasada %}Atrasada{% else %}No prazo{% endif %}
                                    {% if tarefa.dias_restantes is not None %}
                                    <span class="days-remaining">
                                        ({{ tarefa.dias_restantes }} dia{{ tarefa.dias_restantes|pluralize }})
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='{% url 'tarefas:listar_tarefas' %}'">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <a href="{% url 'tarefas:excluir_tarefa' tarefa.pk %}" class="btn btn-danger confirm-delete">
                        <i class="fas fa-trash-alt"></i> Excluir Tarefa
                    </a>
                </div>
            </form>
        </main>
    </div>

    <!-- Rodapé -->
    {% include 'includes/footer.html' %}

    <!-- Scripts -->
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>
        $(document).ready(function() {
            // Confirmação antes de excluir
            $('.confirm-delete').on('click', function() {
                return confirm('Tem certeza que deseja excluir esta tarefa? Esta ação não pode ser desfeita.');
            });

            // Validação do formulário
            $('#tarefaForm').on('submit', function() {
                const prazo = $('#{{ form.prazo.id_for_label }}').val();
                const dataInicio = $('#{{ form.data_inicio.id_for_label }}').val();
                
                if (prazo && dataInicio && new Date(prazo) < new Date(dataInicio)) {
                    alert('O prazo não pode ser anterior à data de início!');
                    return false;
                }
                return true;
            });

            // Atualizar data_lembrete quando prazo ou dias_lembrete mudar
            $('#{{ form.prazo.id_for_label }}, #{{ form.dias_lembrete.id_for_label }}').on('change', function() {
                const prazo = $('#{{ form.prazo.id_for_label }}').val();
                const dias = $('#{{ form.dias_lembrete.id_for_label }}').val();
                
                if (prazo && dias) {
                    const prazoDate = new Date(prazo);
                    prazoDate.setDate(prazoDate.getDate() - parseInt(dias));
                    $('#{{ form.data_lembrete.id_for_label }}').val(prazoDate.toISOString().slice(0, 16));
                }
            });
        });
    </script>
{% endblock %}
