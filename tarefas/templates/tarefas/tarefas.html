
{% load static %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Gerenciamento de Tarefas{% endblock %}</title>
    {% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'csstarefa/tarefastyles.css' %}">
    {% endblock %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

<!-- Barra de Navegação Principal -->    
{% include 'includes/header.html' %}
{% block content %}    
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Gerenciamento de Tarefas</h2>
            <div>
                <a href="{% url 'tarefas:criar_tarefa' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nova Tarefa
                </a>
                <a href="{% url 'tarefas:relatorio_tarefas' %}" class="btn btn-info ml-2">
                    <i class="fas fa-file-alt"></i> Relatório
                </a>
                <a href="{% url 'tarefas:calendario_tarefas' %}" class="btn btn-secondary ml-2">
                    <i class="fas fa-calendar-alt"></i> Calendário
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="form-inline">
                    <div class="form-group mr-3">
                        <label for="status" class="mr-2">Status:</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">Todos</option>
                            {% for status in status_choices %}
                            <option value="{{ status.0 }}" {% if request.GET.status == status.0 %}selected{% endif %}>
                                {{ status.1 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mr-3">
                        <label for="prioridade" class="mr-2">Prioridade:</label>
                        <select name="prioridade" id="prioridade" class="form-control">
                            <option value="">Todas</option>
                            {% for prioridade in prioridade_choices %}
                            <option value="{{ prioridade.0 }}" {% if request.GET.prioridade == prioridade.0 %}selected{% endif %}>
                                {{ prioridade.1 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mr-3">
                        <label for="projeto" class="mr-2">Projeto:</label>
                        <input type="text" name="projeto" id="projeto" class="form-control" 
                               value="{{ request.GET.projeto }}" placeholder="Filtrar por projeto">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <a href="{% url 'tarefas:listar_tarefas' %}" class="btn btn-outline-secondary ml-2">
                        Limpar
                    </a>  
                </form>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Título</th>
                        <th>Projeto</th>
                        <th>Responsável</th>
                        <th>Status</th>
                        <th>Prioridade</th>
                        <th>Início</th>
                        <th>Prazo</th>
                        <th>Progresso</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tarefa in tarefas %}
                    <tr class="{% if tarefa.atrasada %}table-danger{% endif %}">
                        <td>
                            <a href="{% url 'tarefas:tarefa_detail' tarefa.pk %}">
                                {{ tarefa.titulo|truncatechars:30 }}
                            </a>
                            {% if tarefa.data_lembrete and tarefa.data_lembrete <= now %}
                            <span class="badge badge-warning ml-1" title="Lembrete ativo">
                                <i class="fas fa-bell"></i>
                            </span>
                            {% endif %}
                        </td>
                        <td>{{ tarefa.projeto|default:"-"|truncatechars:20 }}</td>
                        <td>{{ tarefa.responsavel.get_full_name|default:tarefa.responsavel.username }}</td>
                        <td>
                            <span class="badge badge-{{ tarefa.status }}">
                                {{ tarefa.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-{{ tarefa.prioridade }}">
                                {{ tarefa.get_prioridade_display }}
                            </span>
                        </td>
                        <td>{{ tarefa.data_inicio|date:"d/m/Y"|default:"-" }}</td>
                        <td>
                            {{ tarefa.prazo|date:"d/m/Y"|default:"-" }}
                            {% if tarefa.dias_restantes is not None %}
                            <br>
                            <small class="text-{% if tarefa.dias_restantes > 3 %}success{% elif tarefa.dias_restantes > 0 %}warning{% else %}danger{% endif %}">
                                ({{ tarefa.dias_restantes }} dia{{ tarefa.dias_restantes|pluralize }})
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ tarefa.progresso }}%;" 
                                     aria-valuenow="{{ tarefa.progresso }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ tarefa.progresso }}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'tarefas:editar_tarefa' tarefa.pk %}" 
                                   class="btn btn-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'tarefas:excluir_tarefa' tarefa.pk %}" 
                                   class="btn btn-danger" title="Excluir">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                                <a href="{% url 'tarefas:tarefa_detail' tarefa.pk %}" 
                                   class="btn btn-info" title="Detalhes">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">Nenhuma tarefa encontrada.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    <!-- Rodapé -->
    {% include 'includes/footer.html' %}
        <!-- Paginação -->
        {% if is_paginated %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&{{ query_params }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ query_params }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <a class="page-link" href="?page={{ num }}&{{ query_params }}">{{ num }}</a>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}&{{ query_params }}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ query_params }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ query_params }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>
        $(document).ready(function() {
            // Tooltips
            $('[title]').tooltip();
            
            // Confirmação para exclusão
            $('.btn-danger').on('click', function() {
                return confirm('Tem certeza que deseja excluir esta tarefa?');
            });
            
            // Atualizar automaticamente o campo data_lembrete quando dias_lembrete muda
            $('#id_dias_lembrete').on('change', function() {
                const prazo = $('#id_prazo').val();
                if (prazo) {
                    const dias = $(this).val();
                    const prazoDate = new Date(prazo);
                    prazoDate.setDate(prazoDate.getDate() - dias);
                    $('#id_data_lembrete').val(prazoDate.toISOString().slice(0, 16));
                }
            });
        });
    </script>
{% endblock %}