{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tarefas/calendario.css' %}">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css' rel='stylesheet' />
{% endblock %}
<style>
    /* Exemplo no seu arquivo CSS */
    .fc-event-status-atrasada {
        background-color: #d9534f; /* Vermelho forte */
        border-color: #d43f3a;
    }
    .fc-event-status-recente {
        background-color: #5cb85c; /* Verde */
        border-color: #4cae4c;
    }
    .fc-event-status-proximo-prazo {
        background-color: #f0ad4e; /* Laranja */
        border-color: #eea236;
    }
    .fc-event-status-em-andamento {
        background-color: #337ab7; /* Azul Padrão */
        border-color: #2e6da4;
    }
</style>
{% block title %}Calendário de Tarefas{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Calendário de Tarefas</h1>
        <div>
            <a href="{% url 'tarefas:listar_tarefas' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
            <a href="{% url 'tarefas:criar_tarefa' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i> Nova Tarefa
            </a>
        </div>    
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.14/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.14/locales/pt-br.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Certifique-se de que a biblioteca Bootstrap JS, incluindo Tooltip, está carregada.
    
    const calendarEl = document.getElementById('calendar');
    // Adicionado tratamento de erro básico para o JSON
    const calendarEvents = JSON.parse('{{ eventos_json|safe }}' || '[]');    
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        // --- INTEGRAÇÃO COM BOOTSTRAP 5 E TEMA ---
        themeSystem: 'bootstrap5',
        
        // --- CONFIGURAÇÕES GERAIS ---
        locale: 'pt-br',
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        buttonText: {
            today: 'Hoje',
            month: 'Mês',
            week: 'Semana',
            list: 'Lista'
        },
        navLinks: true, 
        editable: false,
        dayMaxEvents: true,
        
        // --- DADOS DOS EVENTOS ---
        events: calendarEvents,
        
        // --- ADIÇÃO DA FUNCIONALIDADE ---
        eventDidMount: function(info) {
            // Pega o prazo formatado do extendedProps
            const prazo = info.event.extendedProps.prazo || 'N/A'; 
            
            // Obtém os demais dados de extendedProps
            const status = info.event.extendedProps.status || 'N/A';
            const dataCriacao = info.event.extendedProps.data_criacao || 'N/A';

            // Cria o conteúdo do tooltip (usando o título que já contém o prazo)
            const tooltipContent = `
                <strong>${info.event.title}</strong><br>
                ---<br>
                **Criado em:** ${dataCriacao.substring(0, 10)}<br>
                **Status:** ${status}
            `;

            // Aplica o Tooltip do Bootstrap
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                 new bootstrap.Tooltip(info.el, {
                    title: tooltipContent,
                    placement: 'top', 
                    trigger: 'hover', 
                    html: true 
                });
            } else {
                // Fallback simples
                info.el.setAttribute('title', `Prazo: ${prazo} | Status: ${status} | Criado em: ${dataCriacao}`);
            }
        },
    });

    calendar.render();

    // --- SINCRONIZAÇÃO COM O TEMA GLOBAL ---
    const themeObserver = new MutationObserver(() => {
        calendar.render();
    });

    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
});
</script>
{% endblock %}


