
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/tarefas/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Dashboard Analítico de Tarefas</h1>
        <a href="{% url 'tarefas:listar_tarefas' %}" class="btn btn-outline-secondary">Ver Lista</a>
    </header>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="chart-card">
                <div class="card-body">
                    <h5 class="card-title">Tendência: Criadas vs. Concluídas (por semana)</h5>
                    <div class="chart-container"><canvas id="tendenciaChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card">
                <div class="card-body">
                    <h5 class="card-title">Performance da Equipe (Ativas)</h5>
                    <div class="chart-container"><canvas id="equipeChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="table-card card mb-4">
        <div class="card-header"><h5 class="card-title mb-0">Resumo por Responsável</h5></div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead><tr><th>Responsável</th><th>Tarefas Ativas</th><th>Concluídas (30d)</th></tr></thead>
                <tbody>
                {% for usuario in usuarios_performance %}
                    <tr>
                        <td>{{ usuario.username }}</td>
                        <td><span class="badge bg-primary rounded-pill">{{ usuario.tarefas_ativas|default:0 }}</span></td>
                        <td><span class="badge bg-success rounded-pill">{{ usuario.tarefas_concluidas_30d|default:0 }}</span></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let chartsData;
    try {
        chartsData = JSON.parse('{{ charts_data_json|safe }}');
    } catch (e) {
        console.error("Erro ao analisar os dados JSON do Django:", e);
        chartsData = {};
    }

    const chartInstances = {};

    // FUNÇÃO MELHORADA: Agora lê as cores diretamente das variáveis CSS
    const getThemeOptions = () => {
        const rootStyles = getComputedStyle(document.documentElement);
        return {
            color: rootStyles.getPropertyValue('--bs-body-color').trim(),
            gridColor: rootStyles.getPropertyValue('--bs-border-color-translucent').trim(),
            // Cores dos gráficos
            chartColor1: rootStyles.getPropertyValue('--chart-color-1').trim(),
            chartColor1Light: rootStyles.getPropertyValue('--chart-color-1-light').trim(),
            chartColor2: rootStyles.getPropertyValue('--chart-color-2').trim(),
            chartColor2Light: rootStyles.getPropertyValue('--chart-color-2-light').trim(),
        };
    };

    const renderAllCharts = () => {
        Object.values(chartInstances).forEach(chart => chart.destroy());
        const themeOpts = getThemeOptions();

        // GRÁFICO 1: TENDÊNCIA CRIADAS vs. CONCLUÍDAS (LINHA)
        const tendenciaCtx = document.getElementById('tendenciaChart')?.getContext('2d');
        // CORREÇÃO: Verifica as novas chaves no JSON
        if (tendenciaCtx && chartsData.tendencia_labels) {
            // CORREÇÃO: Usa os dados já processados pela view
            const labels = chartsData.tendencia_labels.map(semana => 
                new Date(semana).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
            );
            
            chartInstances.tendenciaChart = new Chart(tendenciaCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tarefas Criadas',
                        data: chartsData.tendencia_criadas, // << USA DIRETAMENTE
                        borderColor: themeOpts.chartColor1,
                        backgroundColor: themeOpts.chartColor1Light,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Tarefas Concluídas',
                        data: chartsData.tendencia_concluidas, // << USA DIRETAMENTE
                        borderColor: themeOpts.chartColor2,
                        backgroundColor: themeOpts.chartColor2Light,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: themeOpts.color }, grid: { color: themeOpts.gridColor } },
                        y: { ticks: { color: themeOpts.color, stepSize: 1 }, grid: { color: themeOpts.gridColor }, beginAtZero: true }
                    },
                    plugins: { legend: { labels: { color: themeOpts.color } } }
                }
            });
        }

        // GRÁFICO 2: PERFORMANCE DA EQUIPE (BARRAS HORIZONTAIS)
        const equipeCtx = document.getElementById('equipeChart')?.getContext('2d');
        if (equipeCtx && chartsData.performance_equipe) {
            chartInstances.equipeChart = new Chart(equipeCtx, {
                type: 'bar',
                data: {
                    // CORREÇÃO: Adapta para a nova estrutura de dados
                    labels: chartsData.performance_equipe.map(u => u.username),
                    datasets: [{
                        label: 'Tarefas Ativas',
                        data: chartsData.performance_equipe.map(u => u.tarefas_ativas),
                        backgroundColor: themeOpts.chartColor1
                    }, {
                        label: 'Concluídas (30d)',
                        data: chartsData.performance_equipe.map(u => u.tarefas_concluidas_30d),
                        backgroundColor: themeOpts.chartColor2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: themeOpts.color }, grid: { color: themeOpts.gridColor } },
                        y: { stacked: true, ticks: { color: themeOpts.color }, grid: { display: false } }
                    },
                    plugins: { legend: { position: 'top', labels: { color: themeOpts.color } } }
                }
            });
        }
    };

    renderAllCharts();

    // Observa mudanças no tema (dark/light) e recria os gráficos
    const themeObserver = new MutationObserver(renderAllCharts);
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
});
</script>
{% endblock %}
